<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <title>java-甜筒的微笑</title>

  <!-- keywords -->
  
    <meta name="keywords" content="java">
  

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="an special old man">
<meta name="keywords" content="java">
<meta property="og:type" content="website">
<meta property="og:title" content="甜筒的微笑">
<meta property="og:url" content="https://dayu007.github.io/index.html">
<meta property="og:site_name" content="甜筒的微笑">
<meta property="og:description" content="an special old man">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="甜筒的微笑">
<meta name="twitter:description" content="an special old man">
  
    <link rel="alternative" href="/atom.xml" title="甜筒的微笑" type="application/atom+xml">
  
  
    <link rel="icon" href="https://liuyiyi.site/head.jpg">
  
  <link rel="stylesheet" href="/css/style.css">
  
  

  <script src="//cdn.bootcss.com/require.js/2.3.2/require.min.js"></script>
  <script src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>

  
</head></html>
<body>
  <div id="container">
    <div id="particles-js"></div>
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="https://liuyiyi.site/head.jpg" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">dayu007</a></h1>
		</hgroup>

		
		<p class="header-subtitle">努力的人更加快乐</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						<li>友情链接</li>
						
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://github.com/smackgg/hexo-theme-smackdown">smackdown</a>
			        
			        </div>
				</section>
				

				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">dayu007</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="https://liuyiyi.site/head.jpg" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author">dayu007</h1>
			</hgroup>
			
			<p class="header-subtitle">努力的人更加快乐</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap">
  
    <article id="post-CAS是什么？" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/10/17/CAS是什么？/" class="article-date">
  	<time datetime="2019-10-17T02:06:37.000Z" itemprop="datePublished">2019-10-17</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/17/CAS是什么？/">
        CAS是什么？
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="CAS是什么？"><a href="#CAS是什么？" class="headerlink" title="CAS是什么？"></a>CAS是什么？</h1><p>比较并交换（compare and swap）是一条CPU并发原语</p>
<h2 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h2><p>  判断内存中某个位置的值是否为预期值，如果是则更改为新的值，这个过程是原子的，中间不予许中断，解决数据一致性问题。</p>
<h2 id="底层原理"><a href="#底层原理" class="headerlink" title="底层原理"></a>底层原理</h2><h3 id="Unsafe类"><a href="#Unsafe类" class="headerlink" title="Unsafe类"></a>Unsafe类</h3><p> 是CAS的核心类，由于java无法直接访问底层系统，需要通过本地（native）方法访问，Unsafe相当于一个后门，该类可以直接操作特定的内存数据。<br> Unsafe类存在于sun.misc包中，其内部方法操作可以像C的指针一样直接操作内存，因为java中的CAS依赖于Unsafe类中的方法  </p>
<p> <strong>注意</strong><br> Unsafe中的所有方法都是native修饰的，就是说Unsafe中的方法都是直接操作系统底层资源执行任务</p>
<h3 id="底层汇编"><a href="#底层汇编" class="headerlink" title="底层汇编"></a>底层汇编</h3><h2 id="底层代码"><a href="#底层代码" class="headerlink" title="底层代码"></a>底层代码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AtomicInteger类中方法：getAndIncrement，调用Unsafe类中的getAndAddInt</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getAndIncrement</span><span class="params">()</span></span>&#123;</span><br><span class="line"> <span class="keyword">return</span> unsafe.getAndAddInt(<span class="keyword">this</span>,valueOffset,<span class="number">1</span>);</span><br><span class="line"> &#125;</span><br><span class="line"><span class="comment">//Unsafe类中 </span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getAndAddInt</span><span class="params">(Object var1, <span class="keyword">long</span> var2, <span class="keyword">int</span> var4)</span> </span>&#123;</span><br><span class="line"> <span class="keyword">int</span> var5;</span><br><span class="line"> <span class="keyword">do</span> &#123;</span><br><span class="line"> var5 = <span class="keyword">this</span>.getIntVolatile(var1, var2);</span><br><span class="line"> &#125; <span class="keyword">while</span>(!<span class="keyword">this</span>.compareAndSwapInt(var1, var2, var5, var5 + var4));</span><br><span class="line"> <span class="keyword">return</span> var5;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p> <strong>解释:</strong></p>
<ul>
<li>var1是AtomicInteger对象本身</li>
<li>var2是对象值的引用地址</li>
<li>var4是需要变动的数值</li>
<li>var5是通过var1、var2找出的内存中的真实的值<br>方法：用对象的值和var5作比较，如果相同，则更新var5+var4并且返回TRUE，如果不同则继续取值然后再比较，直到更新完成</li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-volatile关键字" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/10/17/volatile关键字/" class="article-date">
  	<time datetime="2019-10-17T02:04:53.000Z" itemprop="datePublished">2019-10-17</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/17/volatile关键字/">
        volatile关键字
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="volatile"><a href="#volatile" class="headerlink" title="volatile"></a>volatile</h1><h2 id="1、volatile是java虚拟机提供轻量级的同步机制"><a href="#1、volatile是java虚拟机提供轻量级的同步机制" class="headerlink" title="1、volatile是java虚拟机提供轻量级的同步机制"></a>1、volatile是java虚拟机提供轻量级的同步机制</h2><ul>
<li>保证可见性</li>
<li>不保证原子性</li>
<li>禁止指令重排     </li>
</ul>
<h2 id="2、JMM"><a href="#2、JMM" class="headerlink" title="2、JMM"></a>2、JMM</h2><ul>
<li>可见性</li>
<li>原子性</li>
<li>VolatileDemo代码演示可见性+原子性</li>
<li>有序性<br>以上线程安全获得保证</li>
</ul>
<p>公众内存和主内存同步延迟现象导致的可见性问题<br>可以使用synchronized活volatile关键字解决，他们都可以使一个线程<strong>修改后的变量立即对其他线程可见</strong></p>
<p>对于指令重排导致的可见性问题和有序性问题<br>可以利用volatile关键字解决，因为volatile的另一个作用就是禁止重排序优化</p>
<p>DCL(Double Check Lock 双端检索机制)<br>不一定线程安全，因为有指令重排的存在，加入volatile可以禁止指令重排</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-redis-学习" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2018/12/27/redis-学习/" class="article-date">
  	<time datetime="2018-12-27T07:46:20.000Z" itemprop="datePublished">2018-12-27</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/12/27/redis-学习/">
        redis 学习
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="redis是什么"><a href="#redis是什么" class="headerlink" title="redis是什么"></a>redis是什么</h2><pre><code>Redis is an open source, BSD licensed, advanced key-value store. It is often referred to as a data structure server since keys can contain strings, hashes, lists, sets and sorted sets.
</code></pre><p>redis是开源,BSD许可,高级的key-value存储系统.<br>可以用来存储字符串,哈希结构,链表,集合,因此,常用来提供数据结构服务.</p>
<h3 id="redis和memcached相比-的独特之处"><a href="#redis和memcached相比-的独特之处" class="headerlink" title="redis和memcached相比,的独特之处"></a>redis和memcached相比,的独特之处</h3><p>1: redis可以用来做存储(storge), 而memccached是用来做缓存(cache)<br>  这个特点主要因为其有”持久化”的功能.</p>
<p>2: 存储的数据有”结构”,对于memcached来说,存储的数据,只有1种类型–”字符串”,而redis则可以存储字符串,链表,哈希结构,集合,有序集合.</p>
<h3 id="Redis下载安装"><a href="#Redis下载安装" class="headerlink" title="Redis下载安装"></a>Redis下载安装</h3><ol>
<li>官方站点: redis.io 下载最新版或者最新stable版</li>
<li>解压源码并进入目录</li>
<li>不用configure</li>
<li>直接make<br>(如果是32位机器 make 32bit)</li>
</ol>
<p>注:易碰到的问题,时间错误.<br>原因: 源码是官方configure过的,但官方configure时,生成的文件有时间戳信息,<br>Make只能发生在configure之后,<br>如果你的虚拟机的时间不对,比如说是2012年<br>解决: date -s ‘yyyy-mm-dd hh:mm:ss’   重写时间<br>    再 clock -w  写入cmos</p>
<ol start="5">
<li><p>可选步骤: make test  测试编译情况<br>(可能出现: need tcl  &gt;8.4这种情况, yum install tcl)</p>
</li>
<li><p>安装到指定的目录,比如<br><code>/usr/local/redis</code><br><code>make  PREFIX=/usr/local/redis install</code><br><strong>注: PREFIX要大写</strong></p>
</li>
</ol>
<p>7: <code>make install</code>之后,得到如下几个文件</p>
<pre><code>redis-benchmark  性能测试工具
redis-check-aof  日志文件检测工(比如断电造成日志损坏,可以检测并修复)
redis-check-dump  快照文件检测工具,效果类上
redis-cli  客户端
redis-server 服务端
</code></pre><p>8: 复制配置文件<br>Cp /path/redis.conf /usr/local/redis</p>
<p>9: 启动与连接<br>/path/to/redis/bin/redis-server  ./path/to/conf-file<br>例:[root@localhost redis]# ./bin/redis-server ./redis.conf </p>
<p>连接: 用redis-cli</p>
<p>#/path/to/redis/bin/redis-cli [-h localhost -p 6379 ]</p>
<p>10: 让redis以后台进程的形式运行<br>编辑conf配置文件,修改如下内容;<br>daemonize yes</p>
<h2 id="Redis对于key的操作命令"><a href="#Redis对于key的操作命令" class="headerlink" title="Redis对于key的操作命令"></a>Redis对于key的操作命令</h2><pre><code>del key1 key2 ... Keyn
</code></pre><p>作用: 删除1个或多个键<br>返回值: 不存在的key忽略掉,返回真正删除的key的数量</p>
<pre><code>rename key newkey
</code></pre><p>作用: 给key赋一个新的key名<br>注:如果newkey已存在,则newkey的原值被覆盖</p>
<pre><code>renamenx key newkey  
</code></pre><p>作用: 把key改名为newkey<br>返回: 发生修改返回1,未发生修改返回0<br>注: nx–&gt; not exists, 即, newkey不存在时,作改名动作</p>
<pre><code>move key db
redis 127.0.0.1:6379[1]&gt; select 2
OK
redis 127.0.0.1:6379[2]&gt; keys *
(empty list or set)
redis 127.0.0.1:6379[2]&gt; select 0
OK
redis 127.0.0.1:6379&gt; keys *
1) &quot;name&quot;
2) &quot;cc&quot;
3) &quot;a&quot;
4) &quot;b&quot;
redis 127.0.0.1:6379&gt; move cc 2
(integer) 1
redis 127.0.0.1:6379&gt; select 2
OK
redis 127.0.0.1:6379[2]&gt; keys *
1) &quot;cc&quot;
redis 127.0.0.1:6379[2]&gt; get cc
&quot;3&quot;
</code></pre><p><em>(注意: 一个redis进程,打开了不止一个数据库, 默认打开16个数据库,从0到15编号,<br>如果想打开更多数据库,可以从配置文件修改)</em></p>
<ul>
<li><code>keys pattern</code> 查询相应的key</li>
</ul>
<p>在redis里,允许模糊查询key<br>有3个通配符 <code>*, ? ,[]</code><br>*: 通配任意多个字符<br>?: 通配单个字符<br>[]: 通配括号内的某1个字符</p>
<figure class="highlight plain"><figcaption><span>127.0.0.1:6379> flushdb</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">OK</span><br><span class="line">redis 127.0.0.1:6379&gt; keys *</span><br><span class="line">(empty list or set)</span><br><span class="line">redis 127.0.0.1:6379&gt; mset one 1 two 2 three 3 four 4</span><br><span class="line">OK</span><br><span class="line">redis 127.0.0.1:6379&gt; keys o*</span><br><span class="line">1) &quot;one&quot;</span><br><span class="line">redis 127.0.0.1:6379&gt; key *o</span><br><span class="line">(error) ERR unknown command &apos;key&apos;</span><br><span class="line">redis 127.0.0.1:6379&gt; keys *o</span><br><span class="line">1) &quot;two&quot;</span><br><span class="line">redis 127.0.0.1:6379&gt; keys ???</span><br><span class="line">1) &quot;one&quot;</span><br><span class="line">2) &quot;two&quot;</span><br><span class="line">redis 127.0.0.1:6379&gt; keys on?</span><br><span class="line">1) &quot;one&quot;</span><br><span class="line">redis 127.0.0.1:6379&gt; set ons yes</span><br><span class="line">OK</span><br><span class="line">redis 127.0.0.1:6379&gt; keys on[eaw]</span><br><span class="line">1) &quot;one&quot;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>randomkey 返回随机key</p>
</li>
<li><p>exists key<br>判断key是否存在,返回1/0</p>
</li>
</ul>
<ul>
<li>type key<br>返回key存储的值的类型<br>有<strong><em>string,link,set,order set, hash</em></strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- ttl key  </span><br><span class="line">作用: 查询key的生命周期</span><br><span class="line">返回: 秒数</span><br><span class="line"></span><br><span class="line">** 注:对于不存在的key或已过期的key/不过期的key,都返回-1</span><br><span class="line">Redis2.8中,对于不存在的key,返回-2 ** </span><br><span class="line"></span><br><span class="line">+ expire key 整型值  </span><br><span class="line">作用: 设置key的生命周期,以秒为单位</span><br><span class="line"></span><br><span class="line">+ 同理: </span><br><span class="line">`pexpire key` 毫秒数, 设置生命周期</span><br><span class="line">`pttl  key` 以毫秒返回生命周期</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">+ persist key  </span><br><span class="line">作用: 把指定key置为永久有效</span><br><span class="line"> </span><br><span class="line">### Redis字符串类型的操作</span><br><span class="line"></span><br><span class="line">+ set key value [ex 秒数] / [px 毫秒数]  [nx] /[xx]   </span><br><span class="line">如: set a 1 ex 10 , 10秒有效</span><br><span class="line">Set a 1 px 9000  , 9秒有效</span><br><span class="line">注: 如果ex,px同时写,以后面的有效期为准</span><br><span class="line">如 set a 1 ex 100 px 9000, 实际有效期是9000毫秒</span><br><span class="line"></span><br><span class="line">+ nx: 表示key不存在时,执行操作</span><br><span class="line">+ xx: 表示key存在时,执行操作</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">+ mset  multi set , 一次性设置多个键值   </span><br><span class="line">例: mset key1 v1 key2 v2 ....</span><br><span class="line"></span><br><span class="line">+ get key  </span><br><span class="line">作用:获取key的值</span><br><span class="line"></span><br><span class="line">+ mget key1 key2 ..keyn   </span><br><span class="line">作用:获取多个key的值</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">+ setrange key offset value   </span><br><span class="line">作用:把字符串的offset偏移字节,改成value</span><br><span class="line">      redis 127.0.0.1:6379&gt; set greet hello</span><br><span class="line">      OK</span><br><span class="line">      redis 127.0.0.1:6379&gt; setrange greet 2 x</span><br><span class="line">      (integer) 5</span><br><span class="line">      redis 127.0.0.1:6379&gt; get greet</span><br><span class="line">      &quot;hexlo&quot;</span><br><span class="line"></span><br><span class="line">**注意: 如果偏移量&gt;字符长度, 该字符自动补0x00**  </span><br><span class="line"></span><br><span class="line">`redis 127.0.0.1:6379&gt; setrange greet 6 !</span><br><span class="line">(integer) 7</span><br><span class="line">redis 127.0.0.1:6379&gt; get greet</span><br><span class="line">&quot;heyyo\x00!&quot;`</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">+ append key value      </span><br><span class="line">作用: 把value追加到key的原值上</span><br><span class="line"></span><br><span class="line">- getrange key start stop   </span><br><span class="line">作用: 是获取字符串中 [start, stop]范围的值</span><br><span class="line">注意: 对于字符串的下标,左数从0开始,右数从-1开始</span><br><span class="line">`redis 127.0.0.1:6379&gt; set title &apos;chinese&apos;</span><br><span class="line">OK</span><br><span class="line">redis 127.0.0.1:6379&gt; getrange title 0 3</span><br><span class="line">&quot;chin&quot;</span><br><span class="line">redis 127.0.0.1:6379&gt; getrange title 1 -2</span><br><span class="line">&quot;hines&quot;`</span><br><span class="line"></span><br><span class="line">	**注意: **   </span><br><span class="line">1: start&gt;=length, 则返回空字符串  </span><br><span class="line">2: stop&gt;=length,则截取至字符结尾   </span><br><span class="line">3: 如果start 所处位置在stop右边, 返回空字符串</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- getset key newvalue    </span><br><span class="line">作用: 获取并返回旧值,设置新值</span><br><span class="line">`redis 127.0.0.1:6379&gt; set cnt 0</span><br><span class="line">OK</span><br><span class="line">redis 127.0.0.1:6379&gt; getset cnt 1</span><br><span class="line">&quot;0&quot;</span><br><span class="line">redis 127.0.0.1:6379&gt; getset cnt 2</span><br><span class="line">&quot;1&quot;`</span><br><span class="line"></span><br><span class="line">- incr key      </span><br><span class="line">作用: 指定的key的值加1,并返回加1后的值</span><br><span class="line"></span><br><span class="line">	**注意:**  </span><br><span class="line">1:不存在的key当成0,再incr操作   </span><br><span class="line">2: 范围为64有符号    </span><br><span class="line"></span><br><span class="line">`incrby key number</span><br><span class="line">redis 127.0.0.1:6379&gt; incrby age  90</span><br><span class="line">(integer) 92</span><br><span class="line"></span><br><span class="line">incrbyfloat key floatnumber</span><br><span class="line">redis 127.0.0.1:6379&gt; incrbyfloat age 3.5</span><br><span class="line">&quot;95.5&quot;</span><br><span class="line"></span><br><span class="line">decr key</span><br><span class="line">redis 127.0.0.1:6379&gt; set age 20</span><br><span class="line">OK</span><br><span class="line">redis 127.0.0.1:6379&gt; decr age</span><br><span class="line">(integer) 19</span><br><span class="line"></span><br><span class="line">decrby key number</span><br><span class="line">redis 127.0.0.1:6379&gt; decrby age 3</span><br><span class="line">(integer) 16`</span><br><span class="line"></span><br><span class="line">- getbit key offset     </span><br><span class="line">作用:获取值的二进制表示,对应位上的值(从左,从0编号)</span><br><span class="line">`redis 127.0.0.1:6379&gt; set char A</span><br><span class="line">OK</span><br><span class="line">redis 127.0.0.1:6379&gt; getbit char 1</span><br><span class="line">(integer) 1</span><br><span class="line">redis 127.0.0.1:6379&gt; getbit char 2</span><br><span class="line">(integer) 0</span><br><span class="line">redis 127.0.0.1:6379&gt; getbit char 7</span><br><span class="line">(integer) 1`</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- setbit  key offset value    </span><br><span class="line">设置offset对应二进制位上的值   </span><br><span class="line">返回: 该位上的旧值</span><br><span class="line"></span><br><span class="line">	**注意: **   </span><br><span class="line">1:如果offset过大,则会在中间填充0,   </span><br><span class="line">2: offset最大大到多少   </span><br><span class="line">3:offset最大2^32-1,可推出最大的的字符串为512M   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">+  bitop operation destkey key1 [key2 ...]   </span><br><span class="line">对key1,key2..keyN作operation,并将结果保存到 destkey 上。   </span><br><span class="line">	operation 可以是 AND 、 OR 、 NOT 、 XOR</span><br><span class="line"></span><br><span class="line">`redis 127.0.0.1:6379&gt; setbit lower 7 0</span><br><span class="line">(integer) 0</span><br><span class="line">redis 127.0.0.1:6379&gt; setbit lower 2 1</span><br><span class="line">(integer) 0</span><br><span class="line">redis 127.0.0.1:6379&gt; get lower</span><br><span class="line">&quot; &quot;</span><br><span class="line">redis 127.0.0.1:6379&gt; set char Q</span><br><span class="line">OK</span><br><span class="line">redis 127.0.0.1:6379&gt; get char</span><br><span class="line">&quot;Q&quot;</span><br><span class="line">redis 127.0.0.1:6379&gt; bitop or char char lower</span><br><span class="line">(integer) 1</span><br><span class="line">redis 127.0.0.1:6379&gt; get char</span><br><span class="line">&quot;q&quot;`</span><br><span class="line"></span><br><span class="line">注意: 对于NOT操作, key不能多个</span><br><span class="line"> </span><br><span class="line">### link 链表结构</span><br><span class="line"></span><br><span class="line">- lpush key value   </span><br><span class="line">作用: 把值插入到链接头部</span><br><span class="line">- rpop key  </span><br><span class="line">作用: 返回并删除链表尾元素</span><br><span class="line">- rpush,lpop: 不解释</span><br><span class="line">- lrange key start  stop  </span><br><span class="line">作用: 返回链表中[start ,stop]中的元素  </span><br><span class="line">规律: 左数从0开始,右数从-1开始</span><br><span class="line"></span><br><span class="line">- lrem key count value  </span><br><span class="line">作用: 从key链表中删除 value值  </span><br><span class="line">注: 删除count的绝对值个value后结束</span><br><span class="line">Count&gt;0 从表头删除</span><br><span class="line">Count&lt;0 从表尾删除</span><br><span class="line"></span><br><span class="line">- ltrim key start stop   </span><br><span class="line">作用: 剪切key对应的链接,切[start,stop]一段,并把该段重新赋给key</span><br><span class="line"></span><br><span class="line">- lindex key index    </span><br><span class="line">作用: 返回index索引上的值,</span><br><span class="line">如  lindex key 2</span><br><span class="line"></span><br><span class="line">- llen key  </span><br><span class="line">作用:计算链接表的元素个数</span><br><span class="line">redis 127.0.0.1:6379&gt; llen task</span><br><span class="line">(integer) 3</span><br><span class="line">redis 127.0.0.1:6379&gt; </span><br><span class="line"></span><br><span class="line">- linsert  key after|before search value   </span><br><span class="line">作用: 在key链表中寻找’search’,并在search值之前|之后,.插入value</span><br><span class="line">注: 一旦找到一个search后,命令就结束了,因此不会插入多个value</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- rpoplpush source dest   </span><br><span class="line">作用: 把source的尾部拿出,放在dest的头部,</span><br><span class="line">并返回 该单元值  </span><br><span class="line">场景: task + bak 双链表完成安全队列</span><br><span class="line">Task列表   bak列表  </span><br><span class="line">业务逻辑:   </span><br><span class="line">1:Rpoplpush task bak  </span><br><span class="line">2:接收返回值,并做业务处理  </span><br><span class="line">3:如果成功,rpop bak 清除任务. 如不成功,下次从bak表里取任务  </span><br><span class="line"></span><br><span class="line">- brpop ,blpop  key timeout  </span><br><span class="line">作用:等待弹出key的尾/头元素,   </span><br><span class="line">Timeout为等待超时时间  </span><br><span class="line">如果timeout为0,则一直等待  </span><br><span class="line">场景: 长轮询Ajax,在线聊天时,能够用到</span><br><span class="line"> </span><br><span class="line">- Setbit 的实际应用  </span><br><span class="line">场景: 1亿个用户, 每个用户 登陆/做任意操作  ,记为 今天活跃,否则记为不活跃  </span><br><span class="line">每周评出: 有奖活跃用户: 连续7天活动</span><br><span class="line">每月评,等等...  </span><br><span class="line">思路: </span><br><span class="line">      Userid   dt  active</span><br><span class="line">      1        2013-07-27  1</span><br><span class="line">      1       2013-0726   1</span><br><span class="line"></span><br><span class="line">如果是放在表中, 1:表急剧增大,2:要用group ,sum运算,计算较慢   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">用: 位图法 bit-map   </span><br><span class="line">Log0721:  ‘011001...............0’  </span><br><span class="line"></span><br><span class="line">......   </span><br><span class="line">log0726 :   ‘011001...............0’   </span><br><span class="line">Log0727 :  ‘0110000.............1’   </span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">1: 记录用户登陆:    </span><br><span class="line">每天按日期生成一个位图, 用户登陆后,把user_id位上的bit值置为1   </span><br><span class="line"> </span><br><span class="line">2: 把1周的位图  and 计算,    </span><br><span class="line">位上为1的,即是连续登陆的用户   </span><br><span class="line"></span><br><span class="line">`</span><br><span class="line">redis 127.0.0.1:6379&gt; setbit mon 100000000 0</span><br><span class="line">(integer) 0</span><br><span class="line">redis 127.0.0.1:6379&gt; setbit mon 3 1</span><br><span class="line">(integer) 0</span><br><span class="line">redis 127.0.0.1:6379&gt; setbit mon 5 1</span><br><span class="line">(integer) 0</span><br><span class="line">redis 127.0.0.1:6379&gt; setbit mon 7 1</span><br><span class="line">(integer) 0</span><br><span class="line">redis 127.0.0.1:6379&gt; setbit thur 100000000 0</span><br><span class="line">(integer) 0</span><br><span class="line">redis 127.0.0.1:6379&gt; setbit thur 3 1</span><br><span class="line">(integer) 0</span><br><span class="line">redis 127.0.0.1:6379&gt; setbit thur 5 1</span><br><span class="line">(integer) 0</span><br><span class="line">redis 127.0.0.1:6379&gt; setbit thur 8 1</span><br><span class="line">(integer) 0</span><br><span class="line">redis 127.0.0.1:6379&gt; setbit wen 100000000 0</span><br><span class="line">(integer) 0</span><br><span class="line">redis 127.0.0.1:6379&gt; setbit wen 3 1</span><br><span class="line">(integer) 0</span><br><span class="line">redis 127.0.0.1:6379&gt; setbit wen 4 1</span><br><span class="line">(integer) 0</span><br><span class="line">redis 127.0.0.1:6379&gt; setbit wen 6 1</span><br><span class="line">(integer) 0</span><br><span class="line">redis 127.0.0.1:6379&gt; bitop and  res mon feb wen</span><br><span class="line">(integer) 12500001`</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">如上例,优点:  </span><br><span class="line">1: 节约空间, 1亿人每天的登陆情况,用1亿bit,约1200WByte,约10M 的字符就能表示  </span><br><span class="line">2: 计算方便   </span><br><span class="line">### 集合 set 相关命令</span><br><span class="line"></span><br><span class="line">**集合的性质: 唯一性,无序性,确定性**</span><br><span class="line"></span><br><span class="line">注: 在string和link的命令中,可以通过range 来访问string中的某几个字符或某几个元素  </span><br><span class="line">但,因为集合的无序性,无法通过下标或范围来访问部分元素. </span><br><span class="line">因此想看元素,要么随机先一个,要么全选</span><br><span class="line"></span><br><span class="line">- sadd key  value1 value2  </span><br><span class="line">作用: 往集合key中增加元素 </span><br><span class="line">- srem value1 value2  </span><br><span class="line">作用: 删除集合中集为 value1 value2的元素  </span><br><span class="line">返回值: 忽略不存在的元素后,真正删除掉的元素的个数</span><br><span class="line">- spop key  </span><br><span class="line">作用: 返回并删除集合中key中1个随机元素  </span><br><span class="line">随机--体现了无序性</span><br><span class="line">- srandmember key  </span><br><span class="line">作用: 返回集合key中,随机的1个元素.  </span><br><span class="line">- sismember key  value  </span><br><span class="line">作用: 判断value是否在key集合中   </span><br><span class="line">是返回1,否返回0 </span><br><span class="line">- smembers key</span><br><span class="line">作用: 返回集中中所有的元素 </span><br><span class="line">- scard key   </span><br><span class="line">作用: 返回集合中元素的个数</span><br><span class="line">- smove source dest value  </span><br><span class="line">作用:把source中的value删除,并添加到dest集合中</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- sinter  key1 key2 key3  </span><br><span class="line">作用: 求出key1 key2 key3 三个集合中的交集,并返回</span><br><span class="line">      redis 127.0.0.1:6379&gt; sadd s1 0 2 4 6</span><br><span class="line">      (integer) 4</span><br><span class="line">      redis 127.0.0.1:6379&gt; sadd s2 1 2 3 4</span><br><span class="line">      (integer) 4</span><br><span class="line">      redis 127.0.0.1:6379&gt; sadd s3 4 8 9 12</span><br><span class="line">      (integer) 4</span><br><span class="line">      redis 127.0.0.1:6379&gt; sinter s1 s2 s3</span><br><span class="line">      1) &quot;4&quot;</span><br><span class="line">      redis 127.0.0.1:6379&gt; sinter s3 s1 s2</span><br><span class="line">      1) &quot;4&quot;</span><br><span class="line"></span><br><span class="line">- sinterstore dest key1 key2 key3  </span><br><span class="line">作用: 求出key1 key2 key3 三个集合中的交集,并赋给dest</span><br><span class="line">- suion key1 key2.. Keyn  </span><br><span class="line">作用: 求出key1 key2 keyn的并集,并返回</span><br><span class="line">- sdiff key1 key2 key3   </span><br><span class="line">作用: 求出key1与key2 key3的差集  </span><br><span class="line">即key1-key2-key3 </span><br><span class="line">- order set 有序集合  </span><br><span class="line">`zadd key score1 value1 score2 value2 ..`</span><br><span class="line">##### 添加元素</span><br><span class="line">      redis 127.0.0.1:6379&gt; zadd stu 18 lily 19 hmm 20 lilei 21 lilei</span><br><span class="line">      (integer) 3</span><br><span class="line"></span><br><span class="line">- zrem key value1 value2 ..  </span><br><span class="line">作用: 删除集合中的元素</span><br><span class="line">- zremrangebyscore key min max  </span><br><span class="line">作用: 按照socre来删除元素,删除score在[min,max]之间的  </span><br><span class="line">        redis 127.0.0.1:6379&gt; zremrangebyscore stu 4 10</span><br><span class="line">        (integer) 2</span><br><span class="line">        redis 127.0.0.1:6379&gt; zrange stu 0 -1</span><br><span class="line">        1) &quot;f&quot;</span><br><span class="line"></span><br><span class="line">- zremrangebyrank key start end  </span><br><span class="line">作用: 按排名删除元素,删除名次在[start,end]之间的  </span><br><span class="line">      redis 127.0.0.1:6379&gt; zremrangebyrank stu 0 1</span><br><span class="line">      (integer) 2</span><br><span class="line">      redis 127.0.0.1:6379&gt; zrange stu 0 -1</span><br><span class="line">      1) &quot;c&quot;</span><br><span class="line">      2) &quot;e&quot;</span><br><span class="line">      3) &quot;f&quot;</span><br><span class="line">      4) &quot;g&quot;</span><br><span class="line"></span><br><span class="line">- zrank key member   </span><br><span class="line">查询member的排名(升续 0名开始)</span><br><span class="line"></span><br><span class="line">- zrevrank key memeber  </span><br><span class="line">查询 member的排名(降续 0名开始)</span><br><span class="line"></span><br><span class="line">-  ZRANGE key start stop [WITHSCORES]   </span><br><span class="line">把集合排序后,返回名次[start,stop]的元素  </span><br><span class="line">默认是升续排列   </span><br><span class="line">Withscores 是把score也打印出来</span><br><span class="line"></span><br><span class="line">- zrevrange key start stop  </span><br><span class="line">作用:把集合降序排列,取名字[start,stop]之间的元素</span><br><span class="line"></span><br><span class="line">- zrangebyscore  key min max [withscores] limit offset N  </span><br><span class="line">作用: 集合(升续)排序后,取score在[min,max]内的元素,  </span><br><span class="line">并跳过 offset个, 取出N个  </span><br><span class="line">      redis 127.0.0.1:6379&gt; zadd stu 1 a 3 b 4 c 9 e 12 f 15 g</span><br><span class="line">      (integer) 6</span><br><span class="line">      redis 127.0.0.1:6379&gt; zrangebyscore stu 3 12 limit 1 2 withscores</span><br><span class="line">      1) &quot;c&quot;</span><br><span class="line">      2) &quot;4&quot;</span><br><span class="line">      3) &quot;e&quot;</span><br><span class="line">      4) &quot;9&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- zcard key  </span><br><span class="line">返回元素个数</span><br><span class="line"></span><br><span class="line">- zcount key min max  </span><br><span class="line">返回[min,max] 区间内元素的数量</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- zinterstore destination numkeys key1 [key2 ...]    </span><br><span class="line">      [WEIGHTS weight [weight ...]] </span><br><span class="line">      [AGGREGATE SUM|MIN|MAX]  </span><br><span class="line">求key1,key2的交集,key1,key2的权重分别是 weight1,weight2  </span><br><span class="line">聚合方法用: sum |min|max  </span><br><span class="line">聚合的结果,保存在dest集合内</span><br><span class="line"></span><br><span class="line">**注意: weights ,aggregate如何理解?**</span><br><span class="line">答: 如果有交集, 交集元素又有socre,score怎么处理?  </span><br><span class="line"> Aggregate sum-&gt;score相加   , min 求最小score, max 最大score  </span><br><span class="line">另: 可以通过weigth设置不同key的权重, 交集时,socre * weights</span><br><span class="line"></span><br><span class="line">详见下例  </span><br><span class="line">      ```    </span><br><span class="line">      redis 127.0.0.1:6379&gt; zadd z1 2 a 3 b 4 c</span><br><span class="line">          (integer) 3</span><br><span class="line">          redis 127.0.0.1:6379&gt; zadd z2 2.5 a 1 b 8 d</span><br><span class="line">          (integer) 3</span><br><span class="line">          redis 127.0.0.1:6379&gt; zinterstore tmp 2 z1 z2</span><br><span class="line">          (integer) 2</span><br><span class="line">          redis 127.0.0.1:6379&gt; zrange tmp 0 -1</span><br><span class="line">          1) &quot;b&quot;</span><br><span class="line">          2) &quot;a&quot;</span><br><span class="line">          redis 127.0.0.1:6379&gt; zrange tmp 0 -1 withscores</span><br><span class="line">          1) &quot;b&quot;</span><br><span class="line">          2) &quot;4&quot;</span><br><span class="line">          3) &quot;a&quot;</span><br><span class="line">          4) &quot;4.5&quot;</span><br><span class="line">          redis 127.0.0.1:6379&gt; zinterstore tmp 2 z1 z2 aggregate sum</span><br><span class="line">          (integer) 2</span><br><span class="line">          redis 127.0.0.1:6379&gt; zrange tmp 0 -1 withscores</span><br><span class="line">          1) &quot;b&quot;</span><br><span class="line">          2) &quot;4&quot;</span><br><span class="line">          3) &quot;a&quot;</span><br><span class="line">          4) &quot;4.5&quot;</span><br><span class="line">          redis 127.0.0.1:6379&gt; zinterstore tmp 2 z1 z2 aggregate min</span><br><span class="line">          (integer) 2</span><br><span class="line">          redis 127.0.0.1:6379&gt; zrange tmp 0 -1 withscores</span><br><span class="line">          1) &quot;b&quot;</span><br><span class="line">          2) &quot;1&quot;</span><br><span class="line">          3) &quot;a&quot;</span><br><span class="line">          4) &quot;2&quot;</span><br><span class="line">          redis 127.0.0.1:6379&gt; zinterstore tmp 2 z1 z2 weights 1 2</span><br><span class="line">          (integer) 2</span><br><span class="line">          redis 127.0.0.1:6379&gt; zrange tmp 0 -1 withscores</span><br><span class="line">          1) &quot;b&quot;</span><br><span class="line">          2) &quot;5&quot;</span><br><span class="line">          3) &quot;a&quot;</span><br><span class="line">          4) &quot;7&quot;</span><br><span class="line">          </span><br><span class="line">```</span><br><span class="line">`````````</span><br></pre></td></tr></table></figure>
<h3 id="Hash-哈希数据类型相关命令"><a href="#Hash-哈希数据类型相关命令" class="headerlink" title="Hash 哈希数据类型相关命令"></a>Hash 哈希数据类型相关命令</h3><ul>
<li><p>hset key field value<br>作用: 把key中 filed域的值设为value<br>注:如果没有field域,直接添加,如果有,则覆盖原field域的值</p>
</li>
<li><p>hmset key field1 value1 [field2 value2 field3 value3 ……fieldn valuen]<br>作用: 设置field1-&gt;N 个域, 对应的值是value1-&gt;N<br>(对应PHP理解为  $key = array(file1=&gt;value1, field2=&gt;value2 ….fieldN=&gt;valueN))  </p>
</li>
<li><p>hget key field<br>作用: 返回key中field域的值</p>
</li>
<li><p>hmget key field1 field2 fieldN<br>作用: 返回key中field1 field2 fieldN域的值</p>
</li>
<li><p>hgetall key<br>作用:返回key中,所有域与其值</p>
</li>
<li><p>hdel key field<br>作用: 删除key中 field域</p>
</li>
<li><p>hlen key<br>作用: 返回key中元素的数量</p>
</li>
</ul>
<p>hexists key field<br>作用: 判断key中有没有field域</p>
<p>hinrby key field value<br>作用: 是把key中的field域的值增长整型值value</p>
<p>hinrby float  key field value<br>作用: 是把key中的field域的值增长浮点值value</p>
<p>hkeys key<br>作用: 返回key中所有的field</p>
<p>kvals key<br>作用: 返回key中所有的value</p>
<p>Redis 中的事务</p>
<p>Redis支持简单的事务</p>
<p>Redis与 mysql事务的对比</p>
<pre><code>Mysql    Redis
</code></pre><p>开启    start transaction    muitl<br>语句    普通sql    普通命令<br>失败    rollback 回滚    discard 取消<br>成功    commit    exec</p>
<p>注: rollback与discard 的区别<br>如果已经成功执行了2条语句, 第3条语句出错.<br>Rollback后,前2条的语句影响消失.<br>Discard只是结束本次事务,前2条语句造成的影响仍然还在</p>
<p>注:<br>在mutil后面的语句中, 语句出错可能有2种情况<br>1: 语法就有问题,<br>这种,exec时,报错, 所有语句得不到执行</p>
<p>2: 语法本身没错,但适用对象有问题. 比如 zadd 操作list对象<br>Exec之后,会执行正确的语句,并跳过有不适当的语句.</p>
<p>(如果zadd操作list这种事怎么避免? 这一点,由程序员负责)</p>
<p>思考:<br>我正在买票<br>Ticket -1 , money -100<br>而票只有1张, 如果在我multi之后,和exec之前, 票被别人买了—即ticket变成0了.<br>我该如何观察这种情景,并不再提交</p>
<p>悲观的想法:<br>世界充满危险,肯定有人和我抢, 给 ticket上锁, 只有我能操作. [悲观锁]</p>
<p>乐观的想法:<br>没有那么人和我抢,因此,我只需要注意,<br>–有没有人更改ticket的值就可以了 [乐观锁]</p>
<p>Redis的事务中,启用的是乐观锁,只负责监测key没有被改动.</p>
<p>具体的命令—-  watch命令<br>例:<br>redis 127.0.0.1:6379&gt; watch ticket<br>OK<br>redis 127.0.0.1:6379&gt; multi<br>OK<br>redis 127.0.0.1:6379&gt; decr ticket<br>QUEUED<br>redis 127.0.0.1:6379&gt; decrby money 100<br>QUEUED<br>redis 127.0.0.1:6379&gt; exec<br>(nil)   // 返回nil,说明监视的ticket已经改变了,事务就取消了.<br>redis 127.0.0.1:6379&gt; get ticket<br>“0”<br>redis 127.0.0.1:6379&gt; get money<br>“200”</p>
<p>watch key1 key2  … keyN<br>作用:监听key1 key2..keyN有没有变化,如果有变, 则事务取消</p>
<p>unwatch<br>作用: 取消所有watch监听</p>
<p>消息订阅</p>
<p>使用办法:<br>订阅端: Subscribe 频道名称<br>发布端: publish 频道名称 发布内容</p>
<p>客户端例子:<br>redis 127.0.0.1:6379&gt; subscribe news<br>Reading messages… (press Ctrl-C to quit)<br>1) “subscribe”<br>2) “news”<br>3) (integer) 1<br>1) “message”<br>2) “news”<br>3) “good good study”<br>1) “message”<br>2) “news”<br>3) “day day up”</p>
<p>服务端例子:<br>redis 127.0.0.1:6379&gt; publish news ‘good good study’<br>(integer) 1<br>redis 127.0.0.1:6379&gt; publish news ‘day day up’<br>(integer) 1</p>
<p>Redis持久化配置</p>
<p>Redis的持久化有2种方式   1快照  2是日志</p>
<p>Rdb快照的配置选项</p>
<p>save 900 1      // 900内,有1条写入,则产生快照<br>save 300 1000   // 如果300秒内有1000次写入,则产生快照<br>save 60 10000  // 如果60秒内有10000次写入,则产生快照<br>(这3个选项都屏蔽,则rdb禁用)</p>
<p>stop-writes-on-bgsave-error yes  // 后台备份进程出错时,主进程停不停止写入?<br>rdbcompression yes    // 导出的rdb文件是否压缩<br>Rdbchecksum   yes //  导入rbd恢复时数据时,要不要检验rdb的完整性<br>dbfilename dump.rdb  //导出来的rdb文件名<br>dir ./  //rdb的放置路径</p>
<p>Aof 的配置<br>appendonly no # 是否打开 aof日志功能</p>
<p>appendfsync always   # 每1个命令,都立即同步到aof. 安全,速度慢<br>appendfsync everysec # 折衷方案,每秒写1次<br>appendfsync no      # 写入工作交给操作系统,由操作系统判断缓冲区大小,统一写入到aof. 同步频率低,速度快,</p>
<p>no-appendfsync-on-rewrite  yes: # 正在导出rdb快照的过程中,要不要停止同步aof<br>auto-aof-rewrite-percentage 100 #aof文件大小比起上次重写时的大小,增长率100%时,重写<br>auto-aof-rewrite-min-size 64mb #aof文件,至少超过64M时,重写</p>
<p>注: 在dump rdb过程中,aof如果停止同步,会不会丢失?<br>答: 不会,所有的操作缓存在内存的队列里, dump完成后,统一操作.</p>
<p>注: aof重写是指什么?<br>答: aof重写是指把内存中的数据,逆化成命令,写入到.aof日志里.<br>以解决 aof日志过大的问题.</p>
<p>问: 如果rdb文件,和aof文件都存在,优先用谁来恢复数据?<br>答: aof</p>
<p>问: 2种是否可以同时用?<br>答: 可以,而且推荐这么做</p>
<p>问: 恢复时rdb和aof哪个恢复的快<br>答: rdb快,因为其是数据的内存映射,直接载入到内存,而aof是命令,需要逐条执行<br>redis 服务器端命令<br>redis 127.0.0.1:6380&gt; time  ,显示服务器时间 , 时间戳(秒), 微秒数<br>1) “1375270361”<br>2) “504511”</p>
<p>redis 127.0.0.1:6380&gt; dbsize  // 当前数据库的key的数量<br>(integer) 2<br>redis 127.0.0.1:6380&gt; select 2<br>OK<br>redis 127.0.0.1:6380[2]&gt; dbsize<br>(integer) 0<br>redis 127.0.0.1:6380[2]&gt; </p>
<p>BGREWRITEAOF 后台进程重写AOF<br>BGSAVE       后台保存rdb快照<br>SAVE         保存rdb快照<br>LASTSAVE     上次保存时间</p>
<p>Slaveof master-Host port  , 把当前实例设为master的slave</p>
<p>Flushall  清空所有库所有键<br>Flushdb  清空当前库所有键<br>Showdown [save/nosave]</p>
<p>注: 如果不小心运行了flushall, 立即 shutdown nosave ,关闭服务器<br>然后 手工编辑aof文件, 去掉文件中的 “flushall ”相关行, 然后开启服务器,就可以导入回原来数据.</p>
<p>如果,flushall之后,系统恰好bgrewriteaof了,那么aof就清空了,数据丢失.</p>
<p>Slowlog 显示慢查询<br>注:多慢才叫慢?<br>答: 由slowlog-log-slower-than 10000 ,来指定,(单位是微秒)</p>
<p>服务器储存多少条慢查询的记录?<br>答: 由 slowlog-max-len 128 ,来做限制</p>
<p>Info [Replication/CPU/Memory..]<br>查看redis服务器的信息</p>
<p>Config get 配置项<br>Config set 配置项 值 (特殊的选项,不允许用此命令设置,如slave-of, 需要用单独的slaveof命令来设置)</p>
<p>Redis运维时需要注意的参数<br>1: 内存</p>
<h1 id="Memory"><a href="#Memory" class="headerlink" title="Memory"></a>Memory</h1><p>used_memory:859192 数据结构的空间<br>used_memory_rss:7634944 实占空间<br>mem_fragmentation_ratio:8.89 前2者的比例,1.N为佳,如果此值过大,说明redis的内存的碎片化严重,可以导出再导入一次.<br>2: 主从复制</p>
<h1 id="Replication"><a href="#Replication" class="headerlink" title="Replication"></a>Replication</h1><p>role:slave<br>master_host:192.168.1.128<br>master_port:6379<br>master_link_status:up</p>
<p>3:持久化</p>
<h1 id="Persistence"><a href="#Persistence" class="headerlink" title="Persistence"></a>Persistence</h1><p>rdb_changes_since_last_save:0<br>rdb_last_save_time:1375224063</p>
<p>4: fork耗时</p>
<p>#Status<br>latest_fork_usec:936  上次导出rdb快照,持久化花费微秒<br>注意: 如果某实例有10G内容,导出需要2分钟,<br>每分钟写入10000次,导致不断的rdb导出,磁盘始处于高IO状态.</p>
<p>5: 慢日志<br>config get/set slowlog-log-slower-than<br>CONFIG get/SET slowlog-max-len<br>slowlog get N 获取慢日志</p>
<p>运行时更改master-slave<br>修改一台slave(设为A)为new master<br>1) 命令该服务不做其他redis服务的slave<br>   命令: slaveof no one<br>2) 修改其readonly为yes</p>
<p>其他的slave再指向new master A<br>1) 命令该服务为new master A的slave<br>   命令格式 slaveof IP port<br>监控工具 sentinel</p>
<p>Sentinel不断与master通信,获取master的slave信息.<br>监听master与slave的状态<br>如果某slave失效,直接通知master去除该slave.</p>
<p>如果master失效,,是按照slave优先级(可配置), 选取1个slave做 new master<br>,把其他slave–&gt; new master</p>
<p>疑问: sentinel与master通信,如果某次因为master IO操作频繁,导致超时,<br>此时,认为master失效,很武断.<br>解决: sentnel允许多个实例看守1个master, 当N台(N可设置)sentinel都认为master失效,才正式失效.</p>
<p>Sentinel选项配置<br>port 26379 # 端口<br>sentinel monitor mymaster 127.0.0.1 6379 2 ,<br>给主机起的名字(不重即可),<br>当2个sentinel实例都认为master失效时,正式失效</p>
<p>sentinel down-after-milliseconds mymaster 30000  多少毫秒后连接不到master认为断开<br>sentinel can-failover mymaster yes #是否允许sentinel修改slave-&gt;master. 如为no,则只能监控,无权修改./<br>sentinel parallel-syncs mymaster 1 , 一次性修改几个slave指向新的new master.<br>sentinel client-reconfig-script mymaster /var/redis/reconfig.sh ,# 在重新配置new master,new slave过程,可以触发的脚本<br>redis 与关系型数据库的适合场景</p>
<p>书签系统<br>create table book (<br>bookid int,<br>title char(20)<br>)engine myisam charset utf8;</p>
<p>insert into book values<br>(5 , ‘PHP圣经’),<br>(6 , ‘ruby实战’),<br>(7 , ‘mysql运维’)<br>(8, ‘ruby服务端编程’);</p>
<p>create table tags (<br>tid int,<br>bookid int,<br>content char(20)<br>)engine myisam charset utf8;</p>
<p>insert into tags values<br>(10 , 5 , ‘PHP’),<br>(11 , 5 , ‘WEB’),<br>(12 , 6 , ‘WEB’),<br>(13 , 6 , ‘ruby’),<br>(14 , 7 , ‘database’),<br>(15 , 8 , ‘ruby’),<br>(16 , 8 , ‘server’);</p>
<h1 id="既有web标签-又有PHP-同时还标签的书-要用连接查询"><a href="#既有web标签-又有PHP-同时还标签的书-要用连接查询" class="headerlink" title="既有web标签,又有PHP,同时还标签的书,要用连接查询"></a>既有web标签,又有PHP,同时还标签的书,要用连接查询</h1><p>select * from tags inner join tags as t on tags.bookid=t.bookid<br>where tags.content=’PHP’ and t.content=’WEB’;</p>
<p>换成key-value存储<br>用kv 来存储<br>set book:5:title ‘PHP圣经’<br>set book:6:title ‘ruby实战’<br>set book:7:title ‘mysql运难’<br>set book:8:title ‘ruby server’</p>
<p>sadd tag:PHP 5<br>sadd tag:WEB 5 6<br>sadd tag:database 7<br>sadd tag:ruby 6 8<br>sadd tag:SERVER 8</p>
<p>查: 既有PHP,又有WEB的书<br>Sinter tag:PHP tag:WEB  #查集合的交集</p>
<p>查: 有PHP或有WEB标签的书<br>Sunin tag:PHP tag:WEB</p>
<p>查:含有ruby,不含WEB标签的书<br>Sdiff tag:ruby tag:WEB #求差集</p>
<p>Redis key 设计技巧</p>
<p>1: 把表名转换为key前缀 如, tag:<br>2: 第2段放置用于区分区key的字段–对应mysql中的主键的列名,如userid<br>3: 第3段放置主键值,如2,3,4…., a , b ,c<br>4: 第4段,写要存储的列名</p>
<p>用户表 user  , 转换为key-value存储<br>userid    username    passworde    email<br>9    Lisi    1111111    <a href="mailto:lisi@163.com" target="_blank" rel="noopener">lisi@163.com</a></p>
<p>set  user:userid:9:username lisi<br>set  user:userid:9:password 111111<br>set  user:userid:9:email   <a href="mailto:lisi@163.com" target="_blank" rel="noopener">lisi@163.com</a></p>
<p>keys user:userid:9*</p>
<p>2 注意:<br>在关系型数据中,除主键外,还有可能其他列也步骤查询,<br>如上表中, username 也是极频繁查询的,往往这种列也是加了索引的.</p>
<p>转换到k-v数据中,则也要相应的生成一条按照该列为主的key-value<br>Set  user:username:lisi:uid  9  </p>
<p>这样,我们可以根据username:lisi:uid ,查出userid=9,<br>再查user:9:password/email …</p>
<p>完成了根据用户名来查询用户信息<br>php-redis扩展编译</p>
<p>1: 到pecl.php.net  搜索redis<br>2: 下载stable版(稳定版)扩展<br>3: 解压,<br>4: 执行/php/path/bin/phpize (作用是检测PHP的内核版本,并为扩展生成相应的编译配置)<br>5: configure –with-php-config=/php/path/bin/php-config<br>6: make &amp;&amp; make install</p>
<p>引入编译出的redis.so插件<br>1: 编辑php.ini<br>2: 添加</p>
<p>redis插件的使用<br>// get instance<br>$redis = new Redis();</p>
<p>// connect to redis server<br>$redis-&gt;open(‘localhost’,6380);<br>$redis-&gt;set(‘user:userid:9:username’,’wangwu’);<br>var_dump($redis-&gt;get(‘user:userid:9:username’));</p>
<p>微博项目的key设计<br>全局相关的key:<br>表名    global<br>列名    操作    备注<br>Global:userid    incr    产生全局的userid<br>Global:postid    Incr    产生全局的postid</p>
<p>用户相关的key(表)<br>表名    user<br>Userid    Username    Password    Authsecret<br>3    Test3    1111111    #U*Q(%_</p>
<p>在redis中,变成以下几个key<br>Key前缀    user<br>User:Userid:<em>    User:userid:</em>Username    User:userid:<em>Password    User:userid:</em>:Authsecret<br>User:userid:3    User:userid:3:Test3    User:userid:3:1111111    User:userid:3:#U*Q(%_</p>
<p>微博相关的表设计<br>表名    post<br>Postid    Userid    Username    Time     Content<br>4    2    Lisi    1370987654f    测试内容</p>
<p>微博在redis中,与表设计对应的key设计<br>Key前缀    post<br>Post:Postid:<em>    Post:postid:</em>Userid    Post:postid:<em>:Username    Post:postid:</em>:Time     Post:postid:*:Content<br>4    2    Lisi    1370987654f    测试内容</p>
<p>关注表: following<br>Following:$userid –&gt;</p>
<p>粉丝表<br>Follower:$userid —&gt;</p>
<p>推送表:revicepost</p>
<p>3    4    7            </p>
<p>=================拉模型,改进=====================</p>
<p>拉取表</p>
<p>3    4    7            </p>
<p>问: 上次我拉取了 A-&gt;5,67,三条微博, 下次刷新home.php, 从&gt;7的微博开始拉取<br>解决: 拉取时,设定一个lastpull时间点, 下次拉取时,取&gt;lastpull的微博</p>
<p>问: 有很多关注人,如何取?<br>解决: 循环自己的关注列表,逐个取他们的新微博</p>
<p>问: 取出来之后放在哪儿?<br>答: pull:$userid的链接里</p>
<p>问: 如果个人中心,只有前1000条<br>答: ltrim,只取前1000条</p>
<p>问: 如果我关注 A,B两人, 从2人中,各取3条最新信息<br>,这3+3条信息, 从时间上,是交错的, 如何按时间排序?<br>答: 我们发布时, 是发布的hash结构, 不能按时间来排序.</p>
<p>解决:  同步时,取微博后,记录本次取的微博的最大id,<br>下次同步时,只取比最大id更大的微博</p>
<p>Time taken for tests:   32.690 seconds<br>Complete requests:      20000<br>Failed requests:        0<br>Write errors:           0<br>Non-2xx responses:      20000<br>Total transferred:      13520000 bytes<br>Total POSTed:           5340000<br>HTML transferred:       9300000 bytes<br>Requests per second:    611.80 [#/sec] (mean)<br>Time per request:       81.726 [ms] (mean)<br>Time per request:       1.635 [ms] (mean, across all concurrent requests)<br>Transfer rate:          403.88 [Kbytes/sec] received<br>                        159.52 kb/s sent<br>                        563.41 kb/s total</p>
<p>Connection Times (ms)<br>              min  mean[+/-sd] median   max<br>Connect:        0    0   0.9      0      19<br>Processing:    14   82   8.4     81     153<br>Waiting:        4   82   8.4     80     153<br>Total:         20   82   8.2     81     153</p>
<p>Percentage of the requests served within a certain time (ms)<br>  50%     81<br>  66%     84<br>  75%     86<br>  80%     88<br>  90%     93<br>  95%     96<br>  98%    100<br>  99%    103<br> 100%    153 (longest request)</p>
<p>测试结果:<br>50个并发, 20000次请求, 虚拟下,未做特殊优化<br>每次请求redis写操作6次.<br>30+秒左右完成.</p>
<p>平均每秒发布700条微博, 4000次redis写入.<br>后台定时任务,回归冷数据入mysql<br>Redis配置文件<br> daemonize yes  # redis是否以后台进程运行<br> Requirepass  密码 # 配置redis连接的密码<br>注:配置密码后,客户端连上服务器,需要先执行授权命令</p>
<h1 id="auth-密码"><a href="#auth-密码" class="headerlink" title="auth 密码"></a>auth 密码</h1>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-docker-容器" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2018/12/27/docker-容器/" class="article-date">
  	<time datetime="2018-12-27T07:05:25.000Z" itemprop="datePublished">2018-12-27</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/12/27/docker-容器/">
        docker 容器
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Docker，主讲：汤小洋"><a href="#Docker，主讲：汤小洋" class="headerlink" title="Docker，主讲：汤小洋"></a>Docker，主讲：<strong>汤小洋</strong></h1><h2 id="一、Docker简介"><a href="#一、Docker简介" class="headerlink" title="一、Docker简介"></a>一、Docker简介</h2><h3 id="1-Docker是什么？"><a href="#1-Docker是什么？" class="headerlink" title="1. Docker是什么？"></a>1. Docker是什么？</h3><p>​    产生背景：</p>
<ul>
<li>开发和运维之间因为环境不同而导致的矛盾（不同的操作系统、软件环境、应用配置等） DevOps</li>
<li>集群环境下每台服务器都配置相同的环境，太麻烦</li>
<li>解决“在我的机器上可以正常工作”的问题</li>
</ul>
<p>​        Docker是一个开源的应用容器引擎，让开发者可以打包他们的应用以及依赖包到一个可移植的容器中，然后发布到任何流行的 Linux 机器上，也可以实现虚拟化。</p>
<p>​    阿里云、百度云等都支持Docker技术</p>
<p>​    官网：<a href="https://www.docker.com/" target="_blank" rel="noopener">https://www.docker.com/</a></p>
<p>​    中文官网：<a href="http://www.docker-cn.com/" target="_blank" rel="noopener">http://www.docker-cn.com/</a></p>
<h3 id="2-Docker作用"><a href="#2-Docker作用" class="headerlink" title="2. Docker作用"></a>2. Docker作用</h3><p>​    Docker是一种容器技术，使用Docker可以：</p>
<ul>
<li>将软件环境安装并配置好，打包成一个镜像Image，然后将该镜像发布出去（Docker仓库）</li>
<li>其他使用者可以在仓库中下载获取这个镜像</li>
<li>通过Docker运行这个镜像，就可以获取同样的环境（容器）</li>
</ul>
<p>​        Docker简化了环境部署和配置，实现“一次构建，处处运行”，避免了因运行环境不一致而导致的异常</p>
<p>​         可以将Docker简单的认为是一个虚拟机，可以运行各种软件环境的虚拟机，但与传统虚拟机技术有所不同</p>
<p>​    Docker容器技术与传统虚拟机技术的区别：</p>
<ul>
<li><p>传统虚拟机技术：模拟一个完整的操作系统，先虚拟出一套硬件，然后在其上安装操作系统，最后在系统上再运行应用程序</p>
<p>缺点：资源占用多，启动慢</p>
</li>
<li><p>Docker容器技术：不是模拟一个完整的操作系统，没有进行硬件虚拟，而是对进程进行隔离，封装成容器，容器内的应用程序是直接使用宿主机的内核，且容器之间是互相隔离的，互不影响</p>
<p>优点：更轻便、效率高、启动快、秒级</p>
</li>
</ul>
<h3 id="3-基本术语"><a href="#3-基本术语" class="headerlink" title="3. 基本术语"></a>3. 基本术语</h3><p>​    术语：</p>
<ul>
<li><p>Docker主机（Host）</p>
<p>安装了Docker程序的主机，运行Docker守护进程</p>
</li>
<li><p>Docker镜像（Image）</p>
<p>将软件环境打包好的模板，用来创建容器的，一个镜像可以创建多个容器</p>
</li>
<li><p>Docker容器（Container）</p>
<p>运行镜像后生成的实例称为容器，每运行一次镜像就会产生一个容器，容器可以启动、停止或删除</p>
<p>容器使用是沙箱机制，互相隔离，是独立是安全的</p>
<p>可以把容器看作是一个简易版的Linux环境，包括用户权限、文件系统和运行的应用等</p>
</li>
<li><p>Docker仓库（Repository）</p>
<p>用来保存镜像的，仓库中包含许多镜像，每个镜像都有不同的标签Tag</p>
<p>官方仓库：<a href="https://hub.docker.com/" target="_blank" rel="noopener">https://hub.docker.com/</a></p>
</li>
</ul>
<p>​        使用Docker的步骤：</p>
<ol>
<li>安装Docker</li>
<li>从Docker仓库中下载软件对应的镜像</li>
<li>运行这个镜像，此时会生成一个Docker容器</li>
<li>对容器的启动/停止就是对软件的启动/停止</li>
</ol>
<h2 id="二、准备Linux系统"><a href="#二、准备Linux系统" class="headerlink" title="二、准备Linux系统"></a>二、准备Linux系统</h2><h3 id="1-安装虚拟机软件"><a href="#1-安装虚拟机软件" class="headerlink" title="1. 安装虚拟机软件"></a>1. 安装虚拟机软件</h3><p>​    VMware、VirtualBox</p>
<p>​    Ubuntu、RHEL、CentOS、Debian、SLES（SUSE）</p>
<h3 id="2-新建虚拟机"><a href="#2-新建虚拟机" class="headerlink" title="2. 新建虚拟机"></a>2. 新建虚拟机</h3><p>​    版本：Red Hat（64-bit）</p>
<p>​    网络：桥接网卡</p>
<p>​    光驱：选择操作系统的iso文件</p>
<h3 id="3-安装CentOS"><a href="#3-安装CentOS" class="headerlink" title="3. 安装CentOS"></a>3. 安装CentOS</h3><h3 id="4-连接Linux服务器"><a href="#4-连接Linux服务器" class="headerlink" title="4. 连接Linux服务器"></a>4. 连接Linux服务器</h3><p>​    步骤：</p>
<ol>
<li><p>查看服务器ip地址、</p>
<p>在虚拟机中执行<code>ip addr</code></p>
</li>
<li><p>连接服务器</p>
<p>在客户端中执行<code>ssh 服务器账户@服务器地址</code>，然后输入密码</p>
<p>注：SSH是Secure Shell的缩写，用于远程登陆访问的协议</p>
</li>
</ol>
<h3 id="5-基本操作"><a href="#5-基本操作" class="headerlink" title="5. 基本操作"></a>5. 基本操作</h3><h4 id="5-1-常用命令"><a href="#5-1-常用命令" class="headerlink" title="5.1 常用命令"></a>5.1 常用命令</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/cpuinfo  <span class="comment"># 查看cpu信息</span></span><br><span class="line">cat /proc/meminfo  <span class="comment"># 查看内存信息</span></span><br><span class="line">uname -r <span class="comment"># 查看内核信息，Docker要求CentOS必须是64位，且内核是3.10及以上</span></span><br><span class="line">sudo reboot <span class="comment"># 重启,sudo表示以管理员root身份执行</span></span><br><span class="line">sudo halt <span class="comment"># 关机</span></span><br></pre></td></tr></table></figure>
<h4 id="5-2-安装软件"><a href="#5-2-安装软件" class="headerlink" title="5.2 安装软件"></a>5.2 安装软件</h4><p>​    使用yum，是一个基于rpm的软件包管理工具</p>
<p>​    用来安装软件包，可以自动解决软件包之间的依赖关系</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install 软件包名  <span class="comment">#　安装</span></span><br><span class="line">yum remove 软件包名 <span class="comment"># 卸载</span></span><br></pre></td></tr></table></figure>
<h2 id="三、Docker安装"><a href="#三、Docker安装" class="headerlink" title="三、Docker安装"></a>三、Docker安装</h2><h3 id="1-安装"><a href="#1-安装" class="headerlink" title="1. 安装"></a>1. 安装</h3><p>​    Docker版本：社区版CE、企业版EE</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置yum源</span></span><br><span class="line">yum install -y yum-utils device-mapper-persistent-data lvm2</span><br><span class="line">yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class="line">yum makecache fast</span><br><span class="line"><span class="comment"># 安装Docker-CE</span></span><br><span class="line">yum -y install docker-ce</span><br></pre></td></tr></table></figure>
<h3 id="2-启动-停止"><a href="#2-启动-停止" class="headerlink" title="2. 启动/停止"></a>2. 启动/停止</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker version <span class="comment"># 查看版本</span></span><br><span class="line">systemctl start docker <span class="comment">#　启动</span></span><br><span class="line">systemctl stop docker　<span class="comment"># 停止</span></span><br><span class="line">systemctl status docker <span class="comment">#　查看状态</span></span><br><span class="line">systemctl restart docker　　<span class="comment"># 重启</span></span><br><span class="line">systemctl <span class="built_in">enable</span> docker  <span class="comment"># 设置开机自动启动</span></span><br><span class="line"><span class="comment"># 验证，运行hello-world</span></span><br><span class="line">docker run hello-world  <span class="comment"># 下载hello-world镜像并运行</span></span><br></pre></td></tr></table></figure>
<h3 id="3-配置Docker镜像加速"><a href="#3-配置Docker镜像加速" class="headerlink" title="3. 配置Docker镜像加速"></a>3. 配置Docker镜像加速</h3><p>​    使用阿里云提供的镜像加速（镜像仓库），也可以使用网易云等</p>
<p>​    步骤：</p>
<ol>
<li><p>注册并登陆“阿里云的开发者平台” <a href="http://dev.aliyun.com" target="_blank" rel="noopener">http://dev.aliyun.com</a></p>
</li>
<li><p>查看专属的加速器地址</p>
</li>
<li><p>配置自己的Docker加速器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/docker/daemon.json</span><br><span class="line">	&#123;</span><br><span class="line">      <span class="string">"registry-mirrors"</span>: [<span class="string">"https://sswv6yx0.mirror.aliyuncs.com"</span>]</span><br><span class="line">    &#125;</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="四、Docker操作"><a href="#四、Docker操作" class="headerlink" title="四、Docker操作"></a>四、Docker操作</h2><p>​    输入<code>docker</code>可以查看Docker的命令用法，输入<code>docker COMMAND --help</code>查看指定命令的详细用法</p>
<h3 id="1-镜像操作"><a href="#1-镜像操作" class="headerlink" title="1. 镜像操作"></a>1. 镜像操作</h3><table>
<thead>
<tr>
<th>操作</th>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>查找</td>
<td>docker search 关键字</td>
<td>可以在Docker Hub网站查看镜像的详细信息，如镜像的tag标签</td>
</tr>
<tr>
<td>抽取</td>
<td>docker pull 镜像名:tag</td>
<td>:tag表示软件的版本，如果不指定默认是latest</td>
</tr>
<tr>
<td>列表</td>
<td>docker images</td>
<td>查看所有本地镜像</td>
</tr>
<tr>
<td>获取元信息</td>
<td>docker inspect 镜像id</td>
<td>获取镜像的元信息，详细信息</td>
</tr>
<tr>
<td>删除</td>
<td>docker rmi -f 镜像id或镜像名:tag</td>
<td>删除指定的本地镜像，-f表示强制删除</td>
</tr>
</tbody>
</table>
<h3 id="2-容器操作"><a href="#2-容器操作" class="headerlink" title="2. 容器操作"></a>2. 容器操作</h3><table>
<thead>
<tr>
<th>操作</th>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>运行</td>
<td>docker run –name 容器名 -i -t -p 主机端口:容器端口  -d  -v 主机目录:容器目录:ro 镜像id或镜像名称:tag</td>
<td>–name 指定容器名，名称自定义，如果不指定会自动命名； -i 以交互模式运行，即以交互模式运行容器；-t 分配一个伪终端，即命令行，通常组合使用-it ；-p 指定端口映射，将主机端口映射到容器内的端口；-d 表示后台运行，即守护式运行容器；-v 指定挂载主机目录到容器目录，默认为rw读写模式，ro表示只读</td>
</tr>
<tr>
<td>列表</td>
<td>docker ps -a  -q</td>
<td>查看正在运行的容器，-a表示显示所有容器，-q表示只显示容器id</td>
</tr>
<tr>
<td>启动</td>
<td>docker start 容器id或容器名称</td>
<td>启动容器</td>
</tr>
<tr>
<td>停止</td>
<td>docker stop 容器id或容器名称</td>
<td>停止正在运行的容器</td>
</tr>
<tr>
<td>删除</td>
<td>docker rm -f 容器id或容器名称</td>
<td>删除容器，-f表示强制删除</td>
</tr>
<tr>
<td>日志</td>
<td>docker logs 容器id或容器名称</td>
<td>获取容器的日志</td>
</tr>
<tr>
<td>在容器中执行</td>
<td>docker exec -it 容器id或容器名称 /bin/bash</td>
<td>进入正在运行的容器中并开启一个交互模式的终端，可以在容器中执行操作</td>
</tr>
<tr>
<td>拷贝文件</td>
<td>docker cp 主机中的文件路径 容器id或容器名称:容器路径；docker cp 容器id或容器名称:容器中的文件路径 主机路径</td>
<td>将文件中的文件拷贝到容器中；将容器中的文件拷贝到主机中</td>
</tr>
<tr>
<td>获取元信息</td>
<td>docker inspect 容器id</td>
<td>获取容器的元信息</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>以CentOS为例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">docker search centos</span><br><span class="line">docker pull centos</span><br><span class="line">docker run --name mycentos -it centos:latest  <span class="comment"># 根据centos:latest镜像运行容器，并以交互模式进入容器中</span></span><br><span class="line"><span class="comment"># 实际上是在Docker容器中运行一个精简版的CentOS系统 </span></span><br><span class="line"><span class="built_in">exit</span> <span class="comment"># 退出并关闭容器</span></span><br><span class="line">docker ps -a</span><br><span class="line">docker start mycentos</span><br><span class="line">docker stop mycentos</span><br><span class="line">docker rm mycentos</span><br><span class="line">docker rm -f $(docker ps -aq)  <span class="comment"># 强制删除所有容器</span></span><br></pre></td></tr></table></figure>
<p>​    <strong>注：Docker容器内实际上是运行着一个精简版的Linux系统</strong></p>
<p>以tomcat为例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 示例1：基本用法</span></span><br><span class="line">docker search tomcat</span><br><span class="line">docker pull tomcat</span><br><span class="line">docker run --name mytomcat -p 8888:8080 -d tomcat </span><br><span class="line"><span class="comment"># 测试：http://宿主机地址：8888</span></span><br><span class="line">docker stop mytomcat</span><br><span class="line">docker ps -a</span><br><span class="line">docker start mytomcat</span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例2：拷贝文件和挂载目录</span></span><br><span class="line">docker run -p 8080:8080 -d tomcat</span><br><span class="line">docker <span class="built_in">exec</span> -it 70cba924861c  /bin/bash</span><br><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/tomcat/webapps/ROOT</span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line"><span class="built_in">echo</span> welcome to tomcat &gt; index.jsp</span><br><span class="line">docker cp index.jsp 70cba924861c:/usr/<span class="built_in">local</span>/tomcat/webapps/ROOT  <span class="comment"># 将宿主机中的文件拷贝到容器中指定的目录中</span></span><br><span class="line"><span class="comment">#　部署web项目，将war文件放到容器中</span></span><br><span class="line">docker cp spring-web.war 70cba924861c:/usr/<span class="built_in">local</span>/tomcat/webapps</span><br><span class="line"></span><br><span class="line"><span class="comment"># 问题：如果项目更改了需要重新拷贝war文件，太麻烦，可以直接挂载目录（也称为数据卷Volume）</span></span><br><span class="line">docker run \</span><br><span class="line">-p 8080:8080 \</span><br><span class="line">-v /my/tomcat/webapps/spring-web.war:/usr/<span class="built_in">local</span>/tomcat/webapps/spring-web.war \</span><br><span class="line">-v /my/tomcat/data:/usr/<span class="built_in">local</span>/tomcat/dataVolume:ro \</span><br><span class="line">-d tomcat</span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例3：启动多个容器，一个镜像可以启动多个容器，互相隔离、独立</span></span><br><span class="line">docker run -p 8081:8080 -d tomcat</span><br><span class="line">docker run -p 8082:8080 -d tomcat</span><br><span class="line">docker run -p 8083:8080 -d tomcat</span><br></pre></td></tr></table></figure>
<h3 id="3-镜像的分层结构"><a href="#3-镜像的分层结构" class="headerlink" title="3. 镜像的分层结构"></a>3. 镜像的分层结构</h3><p>​    tomcat镜像为什么这么大？</p>
<p>​    镜像是一种轻量级、可执行的独立软件包，<strong>用来打包软件运行环境和基于运行环境的软件，包含运行某个软件所需要的所有内容。</strong>    </p>
<p>​    基于UnionFS联合文件系统，采用分层结构，一层一层的堆叠起来，像一个同心圆，但从外面来说，只能看到最外层的文件系统（镜像层）</p>
<p>镜像的分层结构</p>
<p>分层结构：共享资源、便于复用（许多镜像都是从相同的Base基础镜像构建而来的，基础镜像只需要保存一份）</p>
<p>​    镜像都是只读的，而由镜像生成的容器是可修改的</p>
<h3 id="4-创建镜像"><a href="#4-创建镜像" class="headerlink" title="4. 创建镜像"></a>4. 创建镜像</h3><p>​    有时从Docker镜像仓库中下载的镜像不能满足我们的要求，此时可以基于这个镜像（基础镜像）封装一个自己的镜像</p>
<p>​    两种方式：</p>
<ul>
<li>更新镜像：使用docker commit命令</li>
<li>构建镜像：使用docker build命令，需要创建Dockerfile文件</li>
</ul>
<h4 id="4-1-更新镜像"><a href="#4-1-更新镜像" class="headerlink" title="4.1 更新镜像"></a>4.1 更新镜像</h4><p>​    先使用基础镜像创建一个容器，然后对容器进行修改，最后使用commit命令提交为一个新的镜像</p>
<p>​    步骤：</p>
<ol>
<li><p>根据基础镜像，创建容器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name mytomcat -p 8080:8080 -d tomcat</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改容器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it bcd08edac78d  /bin/bash</span><br><span class="line"><span class="built_in">cd</span> webapps/ROOT</span><br><span class="line">rm -f index.jsp</span><br><span class="line"><span class="built_in">echo</span> welcome to tomcat &gt; index.html</span><br><span class="line"><span class="built_in">exit</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>提交为新镜像，语法：<code>docker commit -m=&quot;描述消息&quot; -a=&quot;作者&quot; 容器id或容器名 镜像名:tag</code> </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker commit -m=<span class="string">"修改默认索引页"</span> -a=<span class="string">"汤小洋"</span> bcd08edac78d itany/tomcat:v1</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用新镜像运行容器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name tomcat_v1 -p:8080:8080 -d itany/tomcat:v1</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="4-2-构建镜像"><a href="#4-2-构建镜像" class="headerlink" title="4.2 构建镜像"></a>4.2 构建镜像</h4><p>​    根据Dockerfile文件来自动构建镜像</p>
<p>​    Dockerfile是一个包含创建镜像所有命令的文本文件，使用docker build命令可以根据Dockerfile的内容创建镜像</p>
<p>​    步骤：</p>
<ol>
<li><p>创建一个Dockerfile文件<code>vi Dockerfile</code></p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 基础镜像</span></span><br><span class="line"><span class="keyword">FROM</span> tomcat</span><br><span class="line"></span><br><span class="line"><span class="comment"># 作者</span></span><br><span class="line"><span class="keyword">MAINTAINER</span> tangxiaoyang@itany.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行命令</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> rm -f /usr/<span class="built_in">local</span>/tomcat/webapps/ROOT/index.jsp</span></span><br><span class="line"><span class="bash">RUN <span class="built_in">echo</span> <span class="string">"welcome to tomcat!"</span> &gt; /usr/<span class="built_in">local</span>/tomcat/webapps/ROOT/index.html</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>构建新镜像，语法：<code>docker build -f Dockerfile文件的路径  -t 镜像名:tag 命令执行的上下文</code> </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -f Dockerfile -t itany/tomcat:v2 .</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用新镜像运行容器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 9999:8080 -d itany/tomcat:v2</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="五、Dockerfile详解"><a href="#五、Dockerfile详解" class="headerlink" title="五、Dockerfile详解"></a>五、Dockerfile详解</h2><h3 id="1-简介"><a href="#1-简介" class="headerlink" title="1. 简介"></a>1. 简介</h3><p>​    Dockerfile是用来构建Docker镜像的文件，是由一系列命令和参数构成的脚本</p>
<p>​    Dockerfile从FROM命令开始，紧接着各种命令、参数等，最终会生成一个新的镜像</p>
<p>​    使用Dockerfile构建镜像的步骤：</p>
<ol>
<li>编写Dockerfile文件</li>
<li>使用docker build构建镜像</li>
<li>使用docker run运行容器</li>
</ol>
<h3 id="2-用法"><a href="#2-用法" class="headerlink" title="2. 用法"></a>2. 用法</h3><h4 id="2-1-语法规则"><a href="#2-1-语法规则" class="headerlink" title="2.1 语法规则"></a>2.1 语法规则</h4><ul>
<li>指令必须要大写，且后面必须跟参数</li>
<li>第一条指令必须是FROM，指定Base Image 基础镜像</li>
<li>指令按从上往下的顺序，依次执行</li>
<li>每条指定都会创建一个新的镜像层并提交</li>
<li><code>#</code>表示注释</li>
</ul>
<h4 id="2-2-常用指令"><a href="#2-2-常用指令" class="headerlink" title="2.2 常用指令"></a>2.2 常用指令</h4><table>
<thead>
<tr>
<th>指令</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>FROM</td>
<td>指定基础镜像，即当前新镜像是基于哪个镜像的</td>
</tr>
<tr>
<td>MAINTAINER</td>
<td>指定作者</td>
</tr>
<tr>
<td>RUN</td>
<td>指定构建过程中要运行的命令</td>
</tr>
<tr>
<td>ENV</td>
<td>设置环境变量</td>
</tr>
<tr>
<td>WORKDIR</td>
<td>指定默认的工作目录，即进入容器后默认进入的目录</td>
</tr>
<tr>
<td>VOLUME</td>
<td>创建挂载点，也称容器数据卷，用于数据共享和持久化</td>
</tr>
<tr>
<td>CMD</td>
<td>指定容器启动时要运行的命令，与RUN不同的是，这些命令不是在镜像构建过程中执行的</td>
</tr>
<tr>
<td>ENTRYPOINT</td>
<td>指定容器启动时要运行的命令，与CMD有区别</td>
</tr>
<tr>
<td>COPY</td>
<td>拷贝文件/目录到镜像中</td>
</tr>
<tr>
<td>ADD</td>
<td>拷贝文件到镜像中，且会自动解压缩</td>
</tr>
<tr>
<td>EXPOSE</td>
<td>指定对外暴露的端口</td>
</tr>
</tbody>
</table>
<h3 id="3-案例"><a href="#3-案例" class="headerlink" title="3. 案例"></a>3. 案例</h3><h4 id="3-1-自定义centos镜像"><a href="#3-1-自定义centos镜像" class="headerlink" title="3.1 自定义centos镜像"></a>3.1 自定义centos镜像</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.编写Dockerfile文件</span></span><br><span class="line">vi Dockerfile2</span><br><span class="line">	FROM centos</span><br><span class="line"></span><br><span class="line">	MAINTAINER tangxiaoyang@itany.com</span><br><span class="line"></span><br><span class="line">	ENV MYPATH /usr/<span class="built_in">local</span>/centos</span><br><span class="line">	RUN mkdir -p <span class="variable">$MYPATH</span></span><br><span class="line">	WORKDIR <span class="variable">$MYPATH</span></span><br><span class="line"></span><br><span class="line">	RUN yum -y install vim</span><br><span class="line"></span><br><span class="line">	RUN yum -y install wget</span><br><span class="line"></span><br><span class="line">	<span class="comment"># 创建挂载点，无法指定宿主机上对应的目录，是自动生成的</span></span><br><span class="line">	VOLUME  [<span class="string">"/data1"</span>,<span class="string">"/data2"</span>]</span><br><span class="line"></span><br><span class="line">	CMD [<span class="string">"/bin/bash"</span>]</span><br><span class="line"><span class="comment"># 2.使用docker build构建镜像</span></span><br><span class="line">docker build -f Dockerfile2 -t itany/centos:v1 . </span><br><span class="line"><span class="comment"># 3.使用docker run运行容器</span></span><br><span class="line">docker run -it b25b1dad795c</span><br><span class="line"><span class="comment"># 查看镜像的变更历史</span></span><br><span class="line">docker <span class="built_in">history</span> b25b1dad795c</span><br><span class="line"><span class="comment"># 验证挂载点：</span></span><br><span class="line">/var/lib/docker/volumes/0b001b4cc8db1ebbbb4c537c17a5c44adb700fb0e1b941bc82cc717c4ae196f6/_data</span><br><span class="line">/var/lib/docker/volumes/f020f5a5664bf68312be9f49a640f27ecfb49990b231aaf3d0eb7cb723fa0ddd/_data</span><br></pre></td></tr></table></figure>
<p>​    CMD和ENTRYPOINT的区别（面试题）：</p>
<ul>
<li><p>CMD</p>
<p>在Dockerfile中可以有多个CMD指令，但只有最后一条指令生效，所以一般只有一条CMD指令</p>
<p>CMD指令在被docker run之后的参数覆盖</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vi aaa</span><br><span class="line">	<span class="keyword">FROM</span> centos</span><br><span class="line">	<span class="keyword">CMD</span><span class="bash"> [<span class="string">"/bin/ls"</span>]</span></span><br><span class="line"><span class="bash">	CMD [<span class="string">"/bin/bash"</span>]</span></span><br><span class="line"><span class="bash">docker build -f aaa -t itany/aaa . </span></span><br><span class="line"><span class="bash">docker run -it itany/aaa</span></span><br><span class="line"><span class="bash">docker run -it itany/aaa /bin/<span class="built_in">pwd</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>ENTRYPOINT</p>
<p>docker run之后的参数会被作为ENTRYPOINT指令的参数，组合形成新的命令</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vi bbb</span><br><span class="line">	<span class="keyword">FROM</span> centos</span><br><span class="line">	<span class="keyword">ENTRYPOINT</span><span class="bash"> [<span class="string">"/bin/ls"</span>,<span class="string">"/usr/local"</span>]</span></span><br><span class="line"><span class="bash">docker build -f bbb -t itany/bbb .</span></span><br><span class="line"><span class="bash">docker run -it itany/bbb</span></span><br><span class="line"><span class="bash">docker run -it itany/bbb -l  <span class="comment">#  ls /usr/local -l</span></span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="3-2-自定义tomcat镜像"><a href="#3-2-自定义tomcat镜像" class="headerlink" title="3.2 自定义tomcat镜像"></a>3.2 自定义tomcat镜像</h4><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 准备工作 </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1.编写Dockerfile文件</span></span><br><span class="line">vi Dockerfile</span><br><span class="line">	<span class="keyword">FROM</span> centos</span><br><span class="line">	<span class="keyword">MAINTAINER</span> tangxiaoyang@itany.com</span><br><span class="line">	</span><br><span class="line">	<span class="comment"># 拷贝文件，文件必须与Dockerfile在同一目录下</span></span><br><span class="line">	<span class="keyword">COPY</span><span class="bash"> teacher.txt /usr/<span class="built_in">local</span></span></span><br><span class="line"><span class="bash">	ADD jdk-8u171-linux-x64.tar.gz /usr/<span class="built_in">local</span></span></span><br><span class="line"><span class="bash">	ADD apache-tomcat-8.5.30.tar.gz /usr/<span class="built_in">local</span></span></span><br><span class="line"><span class="bash">	</span></span><br><span class="line"><span class="bash">	<span class="comment"># 配置环境变量</span></span></span><br><span class="line"><span class="bash">	ENV JAVA_HOME /usr/<span class="built_in">local</span>/jdk1.8.0_171</span></span><br><span class="line"><span class="bash">	ENV CLASSPATH .:<span class="variable">$JAVA_HOME</span>/lib</span></span><br><span class="line"><span class="bash">	ENV CATALINA_HOME /usr/<span class="built_in">local</span>/apache-tomcat-8.5.30</span></span><br><span class="line"><span class="bash">	ENV PATH <span class="variable">$PATH</span>:<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$CATALINA_HOME</span>/bin</span></span><br><span class="line"><span class="bash">	</span></span><br><span class="line"><span class="bash">	WORKDIR <span class="variable">$CATALINA_HOME</span></span></span><br><span class="line"><span class="bash">	</span></span><br><span class="line"><span class="bash">	RUN yum -y install vim</span></span><br><span class="line"><span class="bash">	</span></span><br><span class="line"><span class="bash">	EXPOSE 8080</span></span><br><span class="line"><span class="bash">	</span></span><br><span class="line"><span class="bash">	CMD [<span class="string">"catalina.sh"</span>, <span class="string">"run"</span>]</span></span><br><span class="line"><span class="bash"><span class="comment"># 2.使用docker build构建镜像</span></span></span><br><span class="line"><span class="bash">docker build -t itany/tomcat:1.0 .</span></span><br><span class="line"><span class="bash"><span class="comment"># 3.使用docker run运行容器</span></span></span><br><span class="line"><span class="bash">docker run \</span></span><br><span class="line"><span class="bash">--name mytomcat \</span></span><br><span class="line"><span class="bash">-p 8080:8080 \</span></span><br><span class="line"><span class="bash">-v /my/tomcat/webapps/spring-web.war:/usr/<span class="built_in">local</span>/apache-tomcat-8.5.30/webapps/spring-web.war \</span></span><br><span class="line"><span class="bash">-d itany/tomcat:1.0</span></span><br></pre></td></tr></table></figure>
<h2 id="六、使用Docker搭建环境"><a href="#六、使用Docker搭建环境" class="headerlink" title="六、使用Docker搭建环境"></a>六、使用Docker搭建环境</h2><h3 id="1-安装MySQL"><a href="#1-安装MySQL" class="headerlink" title="1. 安装MySQL"></a>1. 安装MySQL</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.拉取镜像</span></span><br><span class="line">docker pull mysql:5.7</span><br><span class="line"><span class="comment"># 2.运行容器</span></span><br><span class="line">docker run --name mysql -p 3306:3306 -e MYSQL_ROOT_PASSWORD=root -d mysql:5.7</span><br><span class="line">docker <span class="built_in">exec</span> -it mysql /bin/bash</span><br><span class="line">find / -name <span class="string">"*mysql*"</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line"><span class="comment"># 3.创建用于挂载的目录</span></span><br><span class="line">mkdir -p /my/mysql/conf <span class="comment"># 挂载配置文件</span></span><br><span class="line">mkdir -p /my/mysql/data <span class="comment"># 挂载数据文件</span></span><br><span class="line">mkdir -p /my/mysql/logs <span class="comment"># 挂载日志文件</span></span><br><span class="line"><span class="comment"># 4.拷贝配置文件并修改</span></span><br><span class="line">docker cp mysql:/etc/mysql/mysql.conf.d/mysqld.cnf /my/mysql/conf/</span><br><span class="line">vi /my/mysql/conf/mysqld.cnf</span><br><span class="line">	character-set-server=utf8</span><br><span class="line"><span class="comment"># 5.重新运行容器	</span></span><br><span class="line">docker rm -f mysql  <span class="comment"># 删除原来的容器</span></span><br><span class="line">docker run \</span><br><span class="line">--name mysql \</span><br><span class="line">-p 3306:3306 \</span><br><span class="line">-v /my/mysql/conf:/etc/mysql/mysql.conf.d/ \</span><br><span class="line">-v /my/mysql/data:/var/lib/mysql \</span><br><span class="line">-v /my/mysql/logs:/logs \</span><br><span class="line">-e MYSQL_ROOT_PASSWORD=root \</span><br><span class="line">-d mysql:5.7</span><br><span class="line"><span class="comment"># 6.访问</span></span><br><span class="line"><span class="comment"># 本地访问</span></span><br><span class="line">docker <span class="built_in">exec</span> -it mysql /bin/bash</span><br><span class="line">mysql -u root -p </span><br><span class="line"><span class="comment"># 远程访问</span></span><br><span class="line">mysql -u root -p -h 宿主机地址</span><br></pre></td></tr></table></figure>
<h3 id="2-安装Redis"><a href="#2-安装Redis" class="headerlink" title="2. 安装Redis"></a>2. 安装Redis</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.拉取镜像</span></span><br><span class="line">docker pull redis</span><br><span class="line"><span class="comment"># 2.创建用于挂载的目录</span></span><br><span class="line">mkdir -p /my/redis/conf </span><br><span class="line">mkdir -p /my/redis/data</span><br><span class="line"><span class="comment"># 3.拷贝配置文件并修改</span></span><br><span class="line">wget http://download.redis.io/releases/redis-4.0.10.tar.gz</span><br><span class="line">tar zxf redis-4.0.10.tar.gz</span><br><span class="line">cp redis.conf /my/redis/conf/</span><br><span class="line">vi redis.conf</span><br><span class="line">	requirepass itany</span><br><span class="line">	appendonly yes</span><br><span class="line"><span class="comment"># 4.运行容器</span></span><br><span class="line">docker run \</span><br><span class="line">--name myredis \</span><br><span class="line">-p 6379:6379 \</span><br><span class="line">-v /my/redis/conf/redis.conf:/usr/<span class="built_in">local</span>/etc/redis/redis.conf \</span><br><span class="line">-v /my/redis/data:/data \</span><br><span class="line">-d redis redis-server /usr/<span class="built_in">local</span>/etc/redis/redis.conf</span><br><span class="line"><span class="comment"># 5.访问</span></span><br><span class="line"><span class="comment"># 本地访问</span></span><br><span class="line">docker <span class="built_in">exec</span> -it myredis /bin/bash</span><br><span class="line">redis-cli</span><br><span class="line"><span class="comment">#　远程访问</span></span><br><span class="line">使用RedisDesktopManager工具连接</span><br></pre></td></tr></table></figure>
<h3 id="3-安装Nginx"><a href="#3-安装Nginx" class="headerlink" title="3. 安装Nginx"></a>3. 安装Nginx</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.拉取镜像</span></span><br><span class="line">docker pull nginx</span><br><span class="line"><span class="comment"># 2.运行容器</span></span><br><span class="line">docker run --name mynginx -p 80:80 -d nginx</span><br><span class="line"><span class="comment"># 3.创建用于挂载的目录</span></span><br><span class="line">mkdir -p /my/nginx  <span class="comment"># 挂载nginx所有数据</span></span><br><span class="line">mkdir -p /my/nginx/html <span class="comment"># 挂载nginx虚拟主机（网站html数据）</span></span><br><span class="line"><span class="comment"># 4.拷贝配置文件</span></span><br><span class="line">docker cp mynginx:/etc/nginx/nginx.conf /my/nginx  <span class="comment"># 拷贝主配置文件</span></span><br><span class="line">docker cp mynginx:/etc/nginx/conf.d /my/nginx <span class="comment"># 拷贝虚拟主机配置文件</span></span><br><span class="line"><span class="built_in">echo</span> welcome to nginx &gt; /my/nginx/html/index.html <span class="comment">#　自定义索引页</span></span><br><span class="line"><span class="comment"># 5.重启运行容器</span></span><br><span class="line">docker rm -f mynginx</span><br><span class="line">docker run \</span><br><span class="line">--name mynginx \</span><br><span class="line">-p 80:80 -p 443:443 \</span><br><span class="line">-v /my/nginx/nginx.conf:/etc/nginx/nginx.conf \</span><br><span class="line">-v /my/nginx/html:/usr/share/nginx/html:ro \</span><br><span class="line">-v /etc/nginx/conf.d:/usr/nginx/conf.d \</span><br><span class="line">-d nginx</span><br><span class="line"><span class="comment"># 6.测试</span></span><br><span class="line">http://宿主机地址</span><br></pre></td></tr></table></figure>
<h2 id="七、将本地镜像发布到阿里云"><a href="#七、将本地镜像发布到阿里云" class="headerlink" title="七、将本地镜像发布到阿里云"></a>七、将本地镜像发布到阿里云</h2><p>​    步骤：</p>
<ol>
<li><p>登陆“阿里云-开发者平台”，创建命名空间和镜像仓库</p>
</li>
<li><p>将镜像推送到阿里云</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 登陆阿里云的docker仓库</span></span><br><span class="line">docker login --username=tangyang8942@163.com registry.cn-hangzhou.aliyuncs.com</span><br><span class="line"><span class="comment"># 创建指定镜像的tag，归入某个仓库</span></span><br><span class="line">docker tag b25b1dad795c registry.cn-hangzhou.aliyuncs.com/itany/centos:v1.0</span><br><span class="line"><span class="comment"># 将镜像推送到仓库中</span></span><br><span class="line">docker push registry.cn-hangzhou.aliyuncs.com/itany/centos:v1.0</span><br></pre></td></tr></table></figure>
</li>
<li><p>拉取镜像</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/itany/centos:v1.0</span><br></pre></td></tr></table></figure>
<p>​</p>
</li>
</ol>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-shiro-学习精华" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2018/12/27/shiro-学习精华/" class="article-date">
  	<time datetime="2018-12-27T06:47:42.000Z" itemprop="datePublished">2018-12-27</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/12/27/shiro-学习精华/">
        shiro 学习精华
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Shiro，主讲：汤小洋"><a href="#Shiro，主讲：汤小洋" class="headerlink" title="Shiro，主讲：汤小洋"></a>Shiro，主讲：汤小洋</h2><h2 id="一、Shrio简介"><a href="#一、Shrio简介" class="headerlink" title="一、Shrio简介"></a>一、Shrio简介</h2><h3 id="1-什么是Shiro"><a href="#1-什么是Shiro" class="headerlink" title="1. 什么是Shiro"></a>1. 什么是Shiro</h3><p>​    Apache <em>Shiro</em>是一个强大且易用的Java安全框架,执行身份验证、授权、密码学和会话管理。</p>
<h3 id="2-主要功能"><a href="#2-主要功能" class="headerlink" title="2. 主要功能"></a>2. 主要功能</h3><p>​    身份验证、授权、加密、会话管理</p>
<h3 id="3-单词"><a href="#3-单词" class="headerlink" title="3. 单词"></a>3. 单词</h3><p>​    authentication 身份验证、认证</p>
<p>​    authorization 授权  authorizing</p>
<p>​    encrypt  加密</p>
<p>​    principals 当事人、用户</p>
<p>​    credential 凭证、密码</p>
<p>​    token 记号、令牌</p>
<p>​    subject  主题、学科、主体</p>
<p>​    strategy 策略</p>
<h2 id="二、身份认证"><a href="#二、身份认证" class="headerlink" title="二、身份认证"></a>二、身份认证</h2><h3 id="1-认证流程图"><a href="#1-认证流程图" class="headerlink" title="1. 认证流程图"></a>1. 认证流程图</h3><h3 id="2-执行过程"><a href="#2-执行过程" class="headerlink" title="2. 执行过程"></a>2. 执行过程</h3><p>​    分5步：</p>
<ol>
<li><p>Subject</p>
<p>用户主体：请求的发起者，即访问应用的用户</p>
</li>
<li><p>SecurityManager</p>
<p>安全管理器：核心，用来分发请求，对Shiro中的其他对象进行管理</p>
</li>
<li><p>Authenticator</p>
<p>认证器：用来进行身份认证</p>
</li>
<li><p>Authentication Strategy</p>
<p>认证策略：如果有多个Real，可以对认证的Realm个数进行配置</p>
</li>
<li><p>Realm</p>
<p>安全数据源，用来进行数据匹配的，可以有多个Realm，如数据库、文件、QQ、微信….</p>
</li>
</ol>
<h2 id="三、第一个Shiro程序"><a href="#三、第一个Shiro程序" class="headerlink" title="三、第一个Shiro程序"></a>三、第一个Shiro程序</h2><h3 id="1-添加jar包"><a href="#1-添加jar包" class="headerlink" title="1. 添加jar包"></a>1. 添加jar包</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="2-核心配置文件"><a href="#2-核心配置文件" class="headerlink" title="2. 核心配置文件"></a>2. 核心配置文件</h3><p>​    Shiro使用的是.ini配置文件，也查键值对，可以进行分类配置，以;或#开头表示注释</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义用户信息，如用户名、密码等</span></span><br><span class="line"><span class="section">[users]</span></span><br><span class="line"><span class="attr">admin</span>=<span class="number">123</span></span><br><span class="line"><span class="attr">tom</span>=<span class="number">456</span></span><br></pre></td></tr></table></figure>
<h3 id="3-基本用法"><a href="#3-基本用法" class="headerlink" title="3. 基本用法"></a>3. 基本用法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.获取SecurityManager，指定配置文件初始化</span></span><br><span class="line">Factory&lt;SecurityManager&gt; factory = <span class="keyword">new</span> IniSecurityManagerFactory(<span class="string">"classpath:shiro01/shiro.ini"</span>);</span><br><span class="line">SecurityManager securityManager = factory.getInstance();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.对SecurityManager进行封装，绑定给SecurityUtils</span></span><br><span class="line">SecurityUtils.setSecurityManager(securityManager);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.获取用户主体Subject</span></span><br><span class="line">Subject subject = SecurityUtils.getSubject();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4.登陆</span></span><br><span class="line">UsernamePasswordToken token = <span class="keyword">new</span> UsernamePasswordToken(<span class="string">"tom"</span>, <span class="string">"456"</span>);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  System.out.println(<span class="string">"是否认证："</span> + subject.isAuthenticated());</span><br><span class="line">  subject.login(token);</span><br><span class="line">  System.out.println(<span class="string">"是否认证："</span> + subject.isAuthenticated());</span><br><span class="line">&#125; <span class="keyword">catch</span> (UnknownAccountException e) &#123;</span><br><span class="line">  System.out.println(<span class="string">"未知的账户："</span> + e.getMessage());</span><br><span class="line">&#125; <span class="keyword">catch</span> (IncorrectCredentialsException e) &#123;</span><br><span class="line">  System.out.println(<span class="string">"错误的密码："</span> + e.getMessage());</span><br><span class="line">&#125; <span class="keyword">catch</span> (AuthenticationException e) &#123;</span><br><span class="line">  System.out.println(<span class="string">"认证异常："</span> + e.getMessage());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//5. 退出</span></span><br><span class="line">subject.logout();</span><br><span class="line">System.out.println(<span class="string">"是否认证："</span> + subject.isAuthenticated());</span><br></pre></td></tr></table></figure>
<h3 id="4-默认配置"><a href="#4-默认配置" class="headerlink" title="4. 默认配置"></a>4. 默认配置</h3><p>​    在.ini核心配置文件中有如下的默认配置：SecurityManager、Authenticator、Authentication Strategy、Realm</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#默认的securitymanager</span></span><br><span class="line"><span class="attr">securitymanager</span>=org.apache.shiro.mgt.defaultsecuritymanager</span><br><span class="line"></span><br><span class="line"><span class="comment">#默认认证器</span></span><br><span class="line"><span class="attr">authenticator</span>=org.apache.shiro.authc.pam.modularrealmauthenticator</span><br><span class="line"><span class="comment">#将认证器添加到SecurityManager中</span></span><br><span class="line">securitymanager.authenticator=$authenticator</span><br><span class="line"></span><br><span class="line"><span class="comment">#默认认证策略</span></span><br><span class="line"><span class="attr">authenticationstrategy</span>=org.apache.shiro.authc.pam.atleastonesuccessfulstrategy</span><br><span class="line"><span class="comment">#将认证策略添加到认证器中，相当于是注入的操作，要以$开头</span></span><br><span class="line">authenticator.authenticationstrategy=$authenticationstrategy</span><br><span class="line"></span><br><span class="line"><span class="comment">#默认的Realm</span></span><br><span class="line"><span class="attr">iniRealm</span>=org.apache.shiro.realm.text.IniRealm</span><br><span class="line"><span class="comment">#将Realm添加到SecurityManager中</span></span><br><span class="line">securitymanager.realms=$iniRealm</span><br></pre></td></tr></table></figure>
<h2 id="四、Realm"><a href="#四、Realm" class="headerlink" title="四、Realm"></a>四、Realm</h2><p>​    默认有三种Realm：IniRealm、JdbcRealm、PropertiesRealm</p>
<h3 id="1-使用JdbcRealm"><a href="#1-使用JdbcRealm" class="headerlink" title="1. 使用JdbcRealm"></a>1. 使用JdbcRealm</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#配置数据源</span></span><br><span class="line"><span class="attr">dataSource</span>=com.alibaba.druid.pool.DruidDataSource</span><br><span class="line">dataSource.driverClassName=com.mysql.jdbc.Driver</span><br><span class="line">dataSource.url=jdbc:mysql://localhost:3306/shiro</span><br><span class="line">dataSource.username=root</span><br><span class="line"></span><br><span class="line"><span class="comment">#使用JdbcRealm</span></span><br><span class="line"><span class="attr">jdbcRealm</span>=org.apache.shiro.realm.jdbc.JdbcRealm</span><br><span class="line"><span class="comment">#注入数据源</span></span><br><span class="line">jdbcRealm.dataSource=$dataSource</span><br><span class="line"><span class="comment">#重写认证的sql</span></span><br><span class="line">jdbcRealm.authenticationQuery=select password from t_user where login_name=?</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#将JdbcRealm添加到SecurityManager</span></span><br><span class="line">securityManager.realms=$jdbcRealm</span><br></pre></td></tr></table></figure>
<h3 id="2-自定义Realm"><a href="#2-自定义Realm" class="headerlink" title="2. 自定义Realm"></a>2. 自定义Realm</h3><p>​    如果使用的是QQ、微信等方式登陆，则需要自定义Realm</p>
<p>​    步骤：</p>
<ol>
<li><p>自定义一个类，继承AuthorizingRealm父类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PropertiesRealm</span> <span class="keyword">extends</span> <span class="title">AuthorizingRealm</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String path;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPath</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> path;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPath</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.path = path;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 授权</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> AuthorizationInfo <span class="title">doGetAuthorizationInfo</span><span class="params">(PrincipalCollection principals)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 身份验证，认证</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> AuthenticationInfo <span class="title">doGetAuthenticationInfo</span><span class="params">(AuthenticationToken token)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">        <span class="comment">//获取token中的用户名</span></span><br><span class="line">        UsernamePasswordToken usernamePasswordToken = (UsernamePasswordToken) token;</span><br><span class="line">        String username = usernamePasswordToken.getUsername();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//查找数据源</span></span><br><span class="line">        Properties p = <span class="keyword">new</span> Properties();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (path.startsWith(<span class="string">"classpath:"</span>)) &#123;</span><br><span class="line">                path = path.substring(<span class="number">10</span>);</span><br><span class="line">                p.load(PropertiesRealm.class.getClassLoader().getResourceAsStream(path));</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (path.startsWith(<span class="string">"file:"</span>)) &#123;</span><br><span class="line">                path = path.substring(<span class="number">5</span>);</span><br><span class="line">                p.load(<span class="keyword">new</span> FileInputStream(path));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e1) &#123;</span><br><span class="line">            e1.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//根据用户名获取密码</span></span><br><span class="line">        String password = p.getProperty(<span class="string">"user."</span> + username);</span><br><span class="line">        <span class="keyword">if</span>(password==<span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UnknownAccountException(<span class="string">"未知的账户！username:"</span>+username);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 返回AuthenticationInfo</span></span><br><span class="line">        AuthenticationInfo authenticationInfo=<span class="keyword">new</span> SimpleAuthenticationInfo(</span><br><span class="line">                username,  <span class="comment">//用户信息</span></span><br><span class="line">                password,  <span class="comment">//该密码是数据源中的真实密码</span></span><br><span class="line">                getName()  <span class="comment">//Realm的名称</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> authenticationInfo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置ini文件</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#使用自定义的PropertiesRealm</span></span><br><span class="line"><span class="attr">propertiesRealm</span>=shiro02.realm.PropertiesRealm</span><br><span class="line">propertiesRealm.path=classpath:shiro02/user.properties</span><br><span class="line"></span><br><span class="line"><span class="comment">#将Realm添加到SecurityManager</span></span><br><span class="line">securityManager.realms=$propertiesRealm</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="五、认证策略"><a href="#五、认证策略" class="headerlink" title="五、认证策略"></a>五、认证策略</h2><h3 id="1-简介"><a href="#1-简介" class="headerlink" title="1. 简介"></a>1. 简介</h3><p>​    针对多个realm，可以对认证realm个数进行配置</p>
<p>​    三种认证策略：</p>
<ul>
<li><p>AtLeastOneSuccessfulStrategy 默认</p>
<p>只要有一个Realm验证成功即可，返回所有Realm身份验证成功的认证消息</p>
</li>
<li><p>FirstSuccessfulStrategy</p>
<p>只要有一个Realm验证成功即可，与AtLeastOneSuccessfulStrategy 的区别在于，其只返回第一个Realm身份验证成功的认证消息</p>
</li>
<li><p>AllSuccessfulStrategy</p>
<p>所有Realm都验证成功才算成功</p>
</li>
</ul>
<h3 id="2-基本操作"><a href="#2-基本操作" class="headerlink" title="2. 基本操作"></a>2. 基本操作</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#认证器</span></span><br><span class="line"><span class="attr">authenticator</span>=org.apache.shiro.authc.pam.ModularRealmAuthenticator</span><br><span class="line"><span class="comment">#认证策略</span></span><br><span class="line"><span class="comment">#authenticationStrategy=org.apache.shiro.authc.pam.AtLeastOneSuccessfulStrategy</span></span><br><span class="line"><span class="comment">#authenticationStrategy=org.apache.shiro.authc.pam.FirstSuccessfulStrategy</span></span><br><span class="line"><span class="attr">authenticationStrategy</span>=org.apache.shiro.authc.pam.AllSuccessfulStrategy</span><br><span class="line">authenticator.authenticationStrategy=$authenticationStrategy</span><br><span class="line"></span><br><span class="line"><span class="comment">#将认证器添加到ScurityManager</span></span><br><span class="line">securityManager.authenticator=$authenticator</span><br></pre></td></tr></table></figure>
<h2 id="六、加密"><a href="#六、加密" class="headerlink" title="六、加密"></a>六、加密</h2><h3 id="1-编码-解码"><a href="#1-编码-解码" class="headerlink" title="1. 编码/解码"></a>1. 编码/解码</h3><p>​    base64、十六进制</p>
<h3 id="2-散列加密"><a href="#2-散列加密" class="headerlink" title="2. 散列加密"></a>2. 散列加密</h3><p>​    Hash散列算法一般用于生成数据的摘要信息，是一种不可逆的算法，一般适合存储密码之类的数据，常见的散列算法如MD5、SHA</p>
<h3 id="3-密码服务和密码匹配器"><a href="#3-密码服务和密码匹配器" class="headerlink" title="3. 密码服务和密码匹配器"></a>3. 密码服务和密码匹配器</h3><h4 id="3-1-简介"><a href="#3-1-简介" class="headerlink" title="3.1 简介"></a>3.1 简介</h4><p>​    PasswordService/ CredentialsMatcher</p>
<ul>
<li><p>PasswordService</p>
<p>用于对明文密码进行加密，以及判断密码是否匹配</p>
<p>实现类：</p>
<p>​    DefaultPasswordService   sha-256  500000</p>
<p>​    自定义实现类</p>
</li>
<li><p>CredentialsMatcher 也称为密码匹配器，用来进行密码匹配</p>
<p>实现类：</p>
<p>​    SimpleCredentialsMatcher 默认的密码匹配器，直接判断密码是否相同</p>
<p>​    HashedCredentialsMatcher 散列密码匹配器</p>
</li>
</ul>
<h4 id="3-2-加密的JdbcRealm"><a href="#3-2-加密的JdbcRealm" class="headerlink" title="3.2 加密的JdbcRealm"></a>3.2 加密的JdbcRealm</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#定义密码匹配器</span></span><br><span class="line"><span class="attr">credentialsMatcher</span>=org.apache.shiro.authc.credential.HashedCredentialsMatcher</span><br><span class="line">credentialsMatcher.hashAlgorithmName=md5</span><br><span class="line"><span class="comment">#将密码匹配器注入到JdbcRealm中</span></span><br><span class="line">jdbcRealm.credentialsMatcher=$credentialsMatcher</span><br></pre></td></tr></table></figure>
<h4 id="3-3-带salt加密的JdbcRealm"><a href="#3-3-带salt加密的JdbcRealm" class="headerlink" title="3.3 带salt加密的JdbcRealm"></a>3.3 带salt加密的JdbcRealm</h4><p>​    步骤：</p>
<ol>
<li><p>自定义了JdbcSaltRealm</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JdbcSaltRealm</span> <span class="keyword">extends</span> <span class="title">JdbcRealm</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JdbcSaltRealm</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//修改saltStyle的值为column</span></span><br><span class="line">        setSaltStyle(SaltStyle.COLUMN);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#使用JdbcRealm</span></span><br><span class="line"><span class="attr">jdbcRealm</span>=shiro04.JdbcSaltRealm</span><br><span class="line">jdbcRealm.dataSource=$dataSource</span><br><span class="line"><span class="comment">#重写带salt的sql</span></span><br><span class="line">jdbcRealm.authenticationQuery=select password,login_name from t_user where login_name=?</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置密码匹配器</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#定义密码匹配器</span></span><br><span class="line"><span class="attr">credentialsMatcher</span>=org.apache.shiro.authc.credential.HashedCredentialsMatcher</span><br><span class="line">credentialsMatcher.hashAlgorithmName=sha-256</span><br><span class="line">credentialsMatcher.hashIterations=3</span><br><span class="line">credentialsMatcher.storedCredentialsHexEncoded=false</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="七、授权"><a href="#七、授权" class="headerlink" title="七、授权"></a>七、授权</h2><h3 id="1-简介-1"><a href="#1-简介-1" class="headerlink" title="1. 简介"></a>1. 简介</h3><p>​    授权也称为访问控制，控制用户对资源的访问</p>
<ul>
<li>权限：增删改查CRUD</li>
<li>角色：一组权限的集合，如系统管理员、老师、学生</li>
</ul>
<h3 id="2-权限表结构"><a href="#2-权限表结构" class="headerlink" title="2. 权限表结构"></a>2. 权限表结构</h3><h3 id="3-授权流程图"><a href="#3-授权流程图" class="headerlink" title="3. 授权流程图"></a>3. 授权流程图</h3><p>分4步：</p>
<ul>
<li><p>Subject</p>
<p>发起请求，判断是否具有相应的角色或权限</p>
</li>
<li><p>SecurityManager</p>
<p>委托给Authorizer</p>
</li>
<li><p>Authorizer</p>
<p>授权器</p>
</li>
<li><p>Realm</p>
<p>查找角色和权限信息</p>
</li>
</ul>
<h3 id="4-基本用法"><a href="#4-基本用法" class="headerlink" title="4. 基本用法"></a>4. 基本用法</h3><h4 id="4-1-基于角色的授权"><a href="#4-1-基于角色的授权" class="headerlink" title="4.1 基于角色的授权"></a>4.1 基于角色的授权</h4><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#用户名=密码,角色1,角色2</span></span><br><span class="line"><span class="section">[users]</span></span><br><span class="line"><span class="attr">admin</span>=<span class="number">123</span>,manager,teacher</span><br><span class="line"><span class="attr">tom</span>=<span class="number">456</span>,student</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">boolean</span> hasRole = subject.hasRole(<span class="string">"student"</span>);</span><br><span class="line">System.out.println(hasRole);</span><br><span class="line"></span><br><span class="line"><span class="keyword">boolean</span>[] hasRoles = subject.hasRoles(Arrays.asList(<span class="string">"manager"</span>, <span class="string">"student"</span>));</span><br><span class="line">System.out.println(Arrays.toString(hasRoles));</span><br><span class="line"></span><br><span class="line"><span class="keyword">boolean</span> hasAllRoles = subject.hasAllRoles(Arrays.asList(<span class="string">"manager"</span>, <span class="string">"teacher"</span>));</span><br><span class="line">System.out.println(hasAllRoles);</span><br></pre></td></tr></table></figure>
<h4 id="4-2-基于权限的授权"><a href="#4-2-基于权限的授权" class="headerlink" title="4.2 基于权限的授权"></a>4.2 基于权限的授权</h4><p>​    也称为基于资源的授权</p>
<p>​    角色权限的配置规则：<code>角色=权限1,权限2</code></p>
<p>​    其中权限的配置规则：<code>资源标识符:操作:实例id</code>,表示对哪个资源的哪个实例具有什么操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">user:update:2</span><br><span class="line">user:update:*  简写 user:update</span><br><span class="line">user:*:* 简写 user 或 user:*（推荐）</span><br><span class="line">*:insert:* 简写  *:insert</span><br><span class="line">user:insert,product:*,customer:view</span><br><span class="line">user:insert,user:update  简写 user:insert,update</span><br></pre></td></tr></table></figure>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#角色=权限1,权限2</span></span><br><span class="line"><span class="section">[roles]</span></span><br><span class="line"><span class="attr">manager</span>=manager:*,teacher:view</span><br><span class="line"><span class="attr">teacher</span>=teacher:*,student:view</span><br><span class="line"><span class="attr">student</span>=student:*</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">boolean</span> permitted = subject.isPermitted(<span class="string">"student:update"</span>);</span><br><span class="line">System.out.println(permitted);</span><br><span class="line"></span><br><span class="line"><span class="keyword">boolean</span>[] permitted1 = subject.isPermitted(<span class="string">"teacher:view"</span>, <span class="string">"manager:view"</span>);</span><br><span class="line">System.out.println(Arrays.toString(permitted1));</span><br><span class="line"></span><br><span class="line"><span class="keyword">boolean</span> permittedAll = subject.isPermittedAll(<span class="string">"teacher:view"</span>, <span class="string">"manager:view"</span>);</span><br><span class="line">System.out.println(permittedAll);</span><br></pre></td></tr></table></figure>
<h3 id="5-基于JdbcRealm的授权配置"><a href="#5-基于JdbcRealm的授权配置" class="headerlink" title="5. 基于JdbcRealm的授权配置"></a>5. 基于JdbcRealm的授权配置</h3><h4 id="5-1-表结构"><a href="#5-1-表结构" class="headerlink" title="5.1 表结构"></a>5.1 表结构</h4><h4 id="5-2-操作"><a href="#5-2-操作" class="headerlink" title="5.2 操作"></a>5.2 操作</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#重写角色的sql</span></span><br><span class="line">jdbcRealm.userRolesQuery=select r.role_name from t_user u  left join user_role ur on u.id=ur.user_id left join t_role r on ur.role_id=r.id where u.login_name=?</span><br><span class="line"></span><br><span class="line"><span class="comment">#启用权限查找</span></span><br><span class="line">jdbcRealm.permissionsLookupEnabled=true</span><br><span class="line"></span><br><span class="line"><span class="comment">#重写权限的sql</span></span><br><span class="line">jdbcRealm.permissionsQuery=select p.permission_name from t_role r left join role_permission rp on r.id=rp.role_id left join t_permission p on rp.permission_id=p.id where r.role_name=?</span><br></pre></td></tr></table></figure>
<h2 id="八、Spring整合Shiro"><a href="#八、Spring整合Shiro" class="headerlink" title="八、Spring整合Shiro"></a>八、Spring整合Shiro</h2><h3 id="1-搭建环境"><a href="#1-搭建环境" class="headerlink" title="1. 搭建环境"></a>1. 搭建环境</h3><p>​    配置SSM环境</p>
<p>​    用户注册</p>
<h3 id="2-密文存储密码"><a href="#2-密文存储密码" class="headerlink" title="2. 密文存储密码"></a>2. 密文存储密码</h3><h3 id="3-实现用户登陆"><a href="#3-实现用户登陆" class="headerlink" title="3. 实现用户登陆"></a>3. 实现用户登陆</h3><p>​    整合Shiro</p>
<p>​    步骤：</p>
<ol>
<li><p>添加jar包</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>配置Shiro过滤器</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 配置Shiro过滤器，用来拦截所有请求，进行认证和授权 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>shiroFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.springframework.web.filter.DelegatingFilterProxy<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>targetFilterLifecycle<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>shiroFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="4-实现登陆验证"><a href="#4-实现登陆验证" class="headerlink" title="4. 实现登陆验证"></a>4. 实现登陆验证</h3><p>​    有些url的访问需要登陆，如果未登陆，则跳转到登陆页面，如/product/findAll</p>
<p>​    解决：配置url过滤规则</p>
<p>​    Shiro默认提供了11个过滤规则，常用的有：</p>
<ul>
<li>anon(AnonymousFilter.class) 不需要验证</li>
<li>authc(FormAuthenticationFilter.class)需要登陆验证</li>
<li>roles(RolesAuthorizationFilter.class)需要角色验证</li>
<li>perms(PermissionsAuthorizationFilter.class)需要权限验证</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 定义url过滤规则 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"filterChainDefinitions"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span></span><br><span class="line">    /showLogin=anon</span><br><span class="line">    /backend/**=authc</span><br><span class="line">    /product/**=authc</span><br><span class="line">  <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 重写默认的登陆失败页面，默认为/login.jsp --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"loginUrl"</span> <span class="attr">value</span>=<span class="string">"/showLogin"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="5-实现角色和权限验证"><a href="#5-实现角色和权限验证" class="headerlink" title="5. 实现角色和权限验证"></a>5. 实现角色和权限验证</h3><h4 id="5-1-角色验证"><a href="#5-1-角色验证" class="headerlink" title="5.1 角色验证"></a>5.1 角色验证</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 重写角色的sql--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"userRolesQuery"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span></span><br><span class="line">    select r.role_name from t_user u  left join user_role ur on u.id=ur.user_id left join t_role r on ur.role_id=r.id where u.login_name=?</span><br><span class="line">  <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/teacher/**=authc,roles[teacher]</span><br><span class="line">/student/**=authc,roles[student]</span><br></pre></td></tr></table></figure>
<h4 id="5-2-权限验证"><a href="#5-2-权限验证" class="headerlink" title="5.2 权限验证"></a>5.2 权限验证</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 开启权限查找 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"permissionsLookupEnabled"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 重写权限的sql --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"permissionsQuery"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span></span><br><span class="line">    select p.permission_name from t_role r left join role_permission rp on r.id=rp.role_id left join t_permission p on rp.permission_id=p.id where r.role_name=?</span><br><span class="line">  <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/teacher/delete=authc,perms[teacher:delete]</span><br></pre></td></tr></table></figure>
<h3 id="6-自定义UserRealm"><a href="#6-自定义UserRealm" class="headerlink" title="6. 自定义UserRealm"></a>6. 自定义UserRealm</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserRealm</span> <span class="keyword">extends</span> <span class="title">AuthorizingRealm</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 授权</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> AuthorizationInfo <span class="title">doGetAuthorizationInfo</span><span class="params">(PrincipalCollection principals)</span> </span>&#123;</span><br><span class="line">        String username= (String) principals.getPrimaryPrincipal();</span><br><span class="line">        System.out.println(username);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取账户的角色和权限</span></span><br><span class="line">        Set&lt;String&gt; roles=userService.findRoles(username);</span><br><span class="line">        Set&lt;String&gt; permissions=userService.findPermissions(username);</span><br><span class="line"></span><br><span class="line">        SimpleAuthorizationInfo authorizationInfo = <span class="keyword">new</span> SimpleAuthorizationInfo();</span><br><span class="line">        authorizationInfo.addRoles(roles);</span><br><span class="line">        authorizationInfo.addStringPermissions(permissions);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> authorizationInfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 认证</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> AuthenticationInfo <span class="title">doGetAuthenticationInfo</span><span class="params">(AuthenticationToken token)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">        String username = (String) token.getPrincipal();</span><br><span class="line"></span><br><span class="line">        User user=userService.findByLoginName(username);</span><br><span class="line">        <span class="comment">//判断账户是否存在</span></span><br><span class="line">        <span class="keyword">if</span>(user==<span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UnknownAccountException();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//返回AuthenticationInfo</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SimpleAuthenticationInfo(</span><br><span class="line">                username, <span class="comment">//用户信息</span></span><br><span class="line">                user.getPassword(), <span class="comment">//密码</span></span><br><span class="line">                ByteSource.Util.bytes(user.getLoginName()), <span class="comment">//salt</span></span><br><span class="line">                getName() <span class="comment">//realm的名称</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="7-Shiro标签库"><a href="#7-Shiro标签库" class="headerlink" title="7. Shiro标签库"></a>7. Shiro标签库</h3><p>​    步骤：</p>
<ol>
<li><p>导入标签库</p>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ taglib prefix=<span class="string">"shiro"</span> uri=<span class="string">"http://shiro.apache.org/tags"</span> %&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>标签</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;shiro:hasAnyRoles name=<span class="string">"teacher,manager"</span>&gt;</span><br><span class="line">   &lt;a href="$&#123;pageContext.request.contextPath&#125;/teacher/findAll"&gt;教师管理系统&lt;/a&gt;</span><br><span class="line">&lt;/shiro:hasAnyRoles&gt;</span><br><span class="line">&lt;shiro:hasRole name=<span class="string">"student"</span>&gt;</span><br><span class="line">  &lt;a href="$&#123;pageContext.request.contextPath&#125;/student/findAll"&gt;学生管理系统&lt;/a&gt;</span><br><span class="line">&lt;/shiro:hasRole&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;shiro:hasPermission name=<span class="string">"teacher:delete"</span>&gt;</span><br><span class="line">  &lt;a href="$&#123;pageContext.request.contextPath&#125;/teacher/delete"&gt;删除&lt;/a&gt;</span><br><span class="line">&lt;/shiro:hasPermission&gt;</span><br></pre></td></tr></table></figure>
<p>​</p>
</li>
</ol>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-hello-world" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2018/12/27/hello-world/" class="article-date">
  	<time datetime="2018-12-27T03:36:00.889Z" itemprop="datePublished">2018-12-27</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/12/27/hello-world/">
        Hello World
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
      <div class="footer-left">
        &copy; 2019 dayu007
      </div>
        <div class="footer-right">
          <a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/smackgg/hexo-theme-smackdown" target="_blank">Smackdown</a>
        </div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="/js/main.js"></script>



<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js"></script>


  </div>
</body>
</html>